"use strict";(self.webpackChunkarcgis_webpack01=self.webpackChunkarcgis_webpack01||[]).push([[59714],{12348:(e,t,s)=>{s.d(t,{Z:()=>r});class r{constructor(e){this.size=0,this._start=0,this.maxSize=e,this._buffer=new Array(e)}get entries(){return this._buffer}enqueue(e){if(this.size===this.maxSize){const t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}dequeue(){if(0===this.size)return null;const e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}peek(){return 0===this.size?null:this._buffer[this._start]}peekLast(){return 0===this.size?null:this._buffer[(this._start+(this.size-1))%this.maxSize]}find(e){if(0===this.size)return null;for(const t of this._buffer)if(null!=t&&e(t))return t;return null}clear(e){let t=this.dequeue();for(;null!=t;)e&&e(t),t=this.dequeue()}}},8774:(e,t,s)=>{s.d(t,{Q:()=>o});var r=s(12348),i=s(19431),n=s(39943);class o{constructor(e,t,s,r,i=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=s,this._purgeOptions=r,this.store=e,this.objectIdField=t,this.purgeInterval=i,this._useGeneratedIds=this.objectIdField===n.r1}removeById(e){this._removed.push(e)}removeByTrackId(e){const t=this._trackIdToObservations.get(e);if(t)for(const e of t.entries)this._removed.push(e)}add(e){if(this._useGeneratedIds){const t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];const t=e.objectId;if(this._addOrUpdated.set(t,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return null==this._trackIdLessObservations&&(this._trackIdLessObservations=new r.Z(1e5)),void this._trackIdLessObservations.enqueue(t);const s=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(s)){const e=null!=this._purgeOptions?.maxObservations?this._purgeOptions.maxObservations:1e3,t=(0,i.uZ)(e,0,1e3);this._trackIdToObservations.set(s,new r.Z(t))}const n=this._trackIdToObservations.get(s)?.enqueue(t);null!=n&&(this._addOrUpdated.has(n)?this._addOrUpdated.delete(n):this._removed.push(n))}checkForUpdates(){const e=this._getToAdd(),t=this._getToRemove(),s=performance.now(),r=s-this._lastPurge,i=Date.now();r>=this.purgeInterval&&(this._purge(s),this._lastPurge=s);const o=[];if(null!=t)for(const e of t){const t=this.store.removeById(e);null!=t&&o.push(t)}const a=[];if(null!=e){const r=new Set(t??[]);for(const t of e)r.has(t.objectId)||(t.attributes[n.gb]=s,t.attributes[n.Y6]=i,this.store.add(t),a.push(t))}return!(!a.length&&!o?.length||(this.store.update(a,o),0))}_getToAdd(){if(!this._addOrUpdated.size)return null;const e=new Array(this._addOrUpdated.size);let t=0;return this._addOrUpdated.forEach((s=>e[t++]=s)),this._addOrUpdated.clear(),e}_getToRemove(){const e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){const e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){const t=this._purgeOptions;null!=t&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField)for(const s of this._trackIdToObservations.values())if(t>e.displayCount&&s.size){const e=s.dequeue();this._removed.push(e),t--}if(null!=this._trackIdLessObservations){let s=t-e.displayCount;for(;s-- >0;){const e=this._trackIdLessObservations.dequeue();null!=e&&this._removed.push(e)}}}}_purgeByAge(e){const t=this._timeInfo?.startTimeField;if(!e.age||!t)return;const s=60*e.age*1e3,r=this._maxAge-s;this.store.forEach((e=>{e.attributes[t]<r&&this._removed.push(e.objectId)}))}_purgeByAgeReceived(e,t){if(!t.ageReceived)return;const s=e-60*t.ageReceived*1e3;this.store.forEach((e=>{e.attributes[n.gb]<s&&this._removed.push(e.objectId)}))}_purgeTracks(){this._trackIdToObservations.forEach(((e,t)=>{0===e.size&&this._trackIdToObservations.delete(t)}))}}},8705:(e,t,s)=>{s.r(t),s.d(t,{createConnection:()=>R});var r=s(36663),i=s(66341),n=s(70375),o=s(13802),a=s(78668),c=s(3466),l=(s(39994),s(4157),s(40266)),u=s(14685),h=s(53736),d=s(81977),p=s(95247),f=s(31355);let _=class extends f.Z.EventedAccessor{destroy(){this.emit("destroy")}get connectionError(){return this.errorString?new n.Z("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}onMessage(e){this.emit("message-received",e)}};(0,r._)([(0,d.Cb)({readOnly:!0})],_.prototype,"connectionError",null),_=(0,r._)([(0,l.j)("esri.layers.support.StreamConnection")],_);const y=_;var g;!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(g||(g={}));let m=class extends y{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;const{geometryType:t,spatialReference:s,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=(0,p.k)(t,r,s),this._open()}normalizeCtorArgs(){return{}}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){super.destroy(),null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case g.CONNECTING:case g.OPEN:return"connected";case g.CLOSING:case g.CLOSED:return"disconnected"}}sendMessageToSocket(e){null!=this._websocket?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,null!=this._websocket&&this._websocket.close()}async _tryCreateWebSocket(e=this._config.source.path,t=1e3,s=0){try{if(this.destroyed)return;const t=(0,c.fl)(e,this._config.customParameters??{});this._websocket=await this._createWebSocket(t),this.notifyChange("connectionStatus")}catch(r){const i=t/1e3;return this._config.maxReconnectionAttempts&&s>=this._config.maxReconnectionAttempts?(o.Z.getLogger(this).error(new n.Z("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(o.Z.getLogger(this).error(new n.Z("websocket-connection",`Failed to connect. Attempting to reconnect in ${i}s`,r)),await(0,a.e4)(t),this._tryCreateWebSocket(e,Math.min(1.5*t,1e3*this._config.maxReconnectionInterval),s+1))}}_setWebSocketJSONParseHandler(e){e.onmessage=e=>{try{const t=JSON.parse(e.data);this._onMessage(t)}catch(e){return void o.Z.getLogger(this).error(new n.Z("websocket-connection","Failed to parse message, invalid JSON",{error:e}))}}}_createWebSocket(e){return new Promise(((t,s)=>{const r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=e=>this._onClose(e),r.onerror=e=>this._onError(e),this._setWebSocketJSONParseHandler(r),t(r)},r.onclose=e=>{r.onopen=r.onclose=null,s(e)}}))}async _handshake(e=1e4){const t=this._websocket;if(null==t)return;const s=(0,a.hh)(),r=t.onmessage,{filter:i,outFields:c,spatialReference:l}=this._config;return s.timeout(e),t.onmessage=e=>{let a=null;try{a=JSON.parse(e.data)}catch(e){}a&&"object"==typeof a||(o.Z.getLogger(this).error(new n.Z("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),s.reject(),this.destroy()),a.spatialReference?.wkid!==l?.wkid&&(o.Z.getLogger(this).error(new n.Z("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${l.wkid}`,e.data)),s.reject(),this.destroy()),"json"!==a.format&&(o.Z.getLogger(this).error(new n.Z("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),s.reject(),this.destroy()),i&&a.filter!==i&&o.Z.getLogger(this).error(new n.Z("websocket-connection","Tried to set filter, but server doesn't support it")),c&&a.outFields!==c&&o.Z.getLogger(this).error(new n.Z("websocket-connection","Tried to set outFields, but server doesn't support it")),t.onmessage=r;for(const e of this._outstandingMessages)t.send(JSON.stringify(e));this._outstandingMessages=[],s.resolve()},t.send(JSON.stringify({filter:i,outFields:c,format:"json",spatialReference:{wkid:l.wkid}})),s.promise}_onMessage(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),o.Z.getLogger(this).error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&o.Z.getLogger(this).error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};(0,r._)([(0,d.Cb)()],m.prototype,"connectionStatus",null),(0,r._)([(0,d.Cb)()],m.prototype,"errorString",void 0),m=(0,r._)([(0,l.j)("esri.layers.graphics.sources.connections.WebSocketConnection")],m);var b=s(28500),w=s(14626);const v={maxQueryDepth:5,maxRecordCountFactor:3};let S=class extends m{constructor(e){super({...v,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||o.Z.getLogger(this).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const t=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);const{filter:s,outFields:r}=this._config;this.destroyed||this._setFilter(s,r)}_onMessage(e){if("attributes"in e){let t;try{t=this._enrich(e),null!=this._featureZScaler&&this._featureZScaler(t.geometry)}catch(e){return void o.Z.getLogger(this).error(new n.Z("geoevent-connection","Failed to parse message",e))}this.onFeature(t)}else this.onMessage(e)}async _fetchServiceDefinition(e){const t={f:"json",...this._config.customParameters},s=(0,i.Z)(e.path,{query:t,responseType:"json"}),r=(await s).data;return this._serviceDefinition=r,r}_fetchWebSocketUrl(e,t){const s=e[0],{urls:r,token:i}=s,n=this._inferWebSocketBaseUrl(r);return(0,c.fl)(`${n}/subscribe`,{outSR:""+t.wkid,token:i})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return o.Z.getLogger(this).error(new n.Z("geoevent-connection","Unable to infer WebSocket url",e)),null}async _setFilter(e,t){const s=this._websocket;if(null==s||null==e&&null==t)return;const r=JSON.stringify({filter:this._serializeFilter(e,t)});let i=!1;const c=(0,a.hh)();return s.onmessage=e=>{const t=JSON.parse(e.data);t.filter&&(t.error&&(o.Z.getLogger(this).error(new n.Z("geoevent-connection","Failed to set service filter",t.error)),this._set("errorString",`Could not set service filter - ${t.error}`),c.reject(t.error)),this._setWebSocketJSONParseHandler(s),i=!0,c.resolve())},s.send(r),setTimeout((()=>{i||(this.destroyed||this._websocket!==s||o.Z.getLogger(this).error(new n.Z("geoevent-connection","Server timed out when setting filter")),c.reject())}),1e4),c.promise}_serializeFilter(e,t){const s={};if(null==e&&null==t)return s;if(e?.geometry)try{const t=(0,h.im)(e.geometry);if("extent"!==t.type)throw new n.Z(`Expected extent but found type ${t.type}`);s.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(e){o.Z.getLogger(this).error(new n.Z("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return e?.where&&"1 = 1"!==e.where&&"1=1"!==e.where&&(s.where=e.where),null!=t&&(s.outFields=t.join(",")),s}_enrich(e){if(!this._relatedFeatures)return e;const t=this._serviceDefinition.relatedFeatures.joinField,s=e.attributes[t],r=this._relatedFeatures.get(s);if(!r)return o.Z.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:i,geometry:a}=r;for(const t in i)e.attributes[t]=i[t];return a&&(e.geometry=a),e.geometry||e.centroid||o.Z.getLogger(this).error(new n.Z("geoevent-connection","Found malformed feature - no geometry found",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,s=this._queryRelatedFeatures(e),r=this._queryArchive(t);await s;const i=await r;if(!i)return;for(const e of i.features)this.onFeature(this._enrich(e))}catch(e){o.Z.getLogger(this).error(new n.Z("geoevent-connection","Encountered an error when querying buddy services",{error:e}))}}async _queryRelatedFeatures(e){if(!e)return;const t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){const t=new((await Promise.all([s.e(41984),s.e(63789),s.e(12926),s.e(92403)]).then(s.bind(s,12926))).default)({url:e}),{capabilities:r}=await t.load(),i=r.query.supportsMaxRecordCountFactor,n=r.query.supportsPagination,o=r.query.supportsCentroid,a=this._config.maxRecordCountFactor,c=t.capabilities.query.maxRecordCount,l=i?c*a:c,h=new w.Z;if(h.outFields=this._config.outFields??["*"],h.where=this._config.filter?.where??"1=1",h.returnGeometry=!0,h.returnExceededLimitFeatures=!0,h.outSpatialReference=u.Z.fromJSON(this._config.spatialReference),o&&(h.returnCentroid=!0),i&&(h.maxRecordCountFactor=a),n)return h.num=l,t.destroy(),this._queryPages(e,h);const d=await(0,b.JT)(e,h,this._config.sourceSpatialReference);return t.destroy(),d.data}async _queryPages(e,t,s=[],r=0){t.start=null!=t.num?r*t.num:null;const{data:i}=await(0,b.JT)(e,t,this._config.sourceSpatialReference);return i.exceededTransferLimit&&r<(this._config.maxQueryDepth??0)?(i.features.forEach((e=>s.push(e))),this._queryPages(e,t,s,r+1)):(s.forEach((e=>i.features.push(e))),i)}_addRelatedFeatures(e){const t=new Map,s=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(const e of s){const s=e.attributes[r];t.set(s,e)}this._relatedFeatures=t}};S=(0,r._)([(0,l.j)("esri.layers.graphics.sources.connections.GeoEventConnection")],S);const C=S;let I=class extends y{constructor(e){super({}),this.connectionStatus="connected",this.errorString=null;const{geometryType:t,spatialReference:s,sourceSpatialReference:r}=e;this._featureZScaler=(0,p.k)(t,r,s)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if("type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}this.onMessage(e)}};function k(e,t){if(null==e&&null==t)return null;const s={};return null!=t&&(s.geometry=t),null!=e&&(s.where=e),s}function R(e,t,s,r,i,n,o,a,c){const l={source:e,sourceSpatialReference:t,spatialReference:s,geometryType:r,filter:k(i,n),maxReconnectionAttempts:o,maxReconnectionInterval:a,customParameters:c};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new m(l):new C(l):new I(l)}(0,r._)([(0,d.Cb)()],I.prototype,"connectionStatus",void 0),(0,r._)([(0,d.Cb)()],I.prototype,"errorString",void 0),I=(0,r._)([(0,l.j)("esri.layers.support.ClientSideConnection")],I)},15553:(e,t,s)=>{s.d(t,{Z:()=>y});var r,i=s(36663),n=s(25709),o=s(82064),a=s(67134),c=s(81977),l=(s(39994),s(13802),s(40266)),u=s(59659),h=s(14626),d=s(49684);const p=new n.X({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),f=new n.X({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let _=r=class extends o.Z{constructor(e){super(e),this.where=null,this.geometry=null,this.spatialRelationship="intersects",this.distance=void 0,this.objectIds=null,this.units=null,this.timeExtent=null}createQuery(e={}){const{where:t,geometry:s,spatialRelationship:r,timeExtent:i,objectIds:n,units:o,distance:c}=this;return new h.Z({geometry:(0,a.d9)(s),objectIds:(0,a.d9)(n),spatialRelationship:r,timeExtent:(0,a.d9)(i),where:t,units:o,distance:c,...e})}clone(){const{where:e,geometry:t,spatialRelationship:s,timeExtent:i,objectIds:n,units:o,distance:c}=this;return new r({geometry:(0,a.d9)(t),objectIds:(0,a.d9)(n),spatialRelationship:s,timeExtent:(0,a.d9)(i),where:e,units:o,distance:c})}};(0,i._)([(0,c.Cb)({type:String,json:{write:!0}})],_.prototype,"where",void 0),(0,i._)([(0,c.Cb)({types:u.qM,json:{write:!0}})],_.prototype,"geometry",void 0),(0,i._)([(0,c.Cb)({type:p.apiValues,json:{name:"spatialRel",read:{reader:p.read},write:{allowNull:!1,writer:p.write,overridePolicy(){return{enabled:null!=this.geometry}}}}})],_.prototype,"spatialRelationship",void 0),(0,i._)([(0,c.Cb)({type:Number,json:{write:{overridePolicy(e){return{enabled:null!=e&&null!=this.geometry}}}}})],_.prototype,"distance",void 0),(0,i._)([(0,c.Cb)({type:[Number],json:{write:!0}})],_.prototype,"objectIds",void 0),(0,i._)([(0,c.Cb)({type:f.apiValues,json:{read:f.read,write:{writer:f.write,overridePolicy(e){return{enabled:null!=e&&null!=this.geometry}}}}})],_.prototype,"units",void 0),(0,i._)([(0,c.Cb)({type:d.Z,json:{write:!0}})],_.prototype,"timeExtent",void 0),_=r=(0,i._)([(0,l.j)("esri.layers.support.FeatureFilter")],_);const y=_},21586:(e,t,s)=>{function r(e){const t=e.layer;return"floorInfo"in t&&t.floorInfo?.floorField&&"floors"in e.view?n(e.view.floors,t.floorInfo.floorField):null}function i(e,t){return"floorInfo"in t&&t.floorInfo?.floorField?n(e,t.floorInfo.floorField):null}function n(e,t){if(!e?.length)return null;const s=e.filter((e=>""!==e)).map((e=>`'${e}'`));return s.push("''"),`${t} IN (${s.join(",")}) OR ${t} IS NULL`}s.d(t,{c:()=>r,f:()=>i})},39943:(e,t,s)=>{s.d(t,{Y6:()=>o,ZO:()=>c,Zs:()=>a,gb:()=>i,m6:()=>n,r1:()=>r});const r="__esri_stream_id__",i="__esri_timestamp__",n="__esri_track_part__",o="__esri_time_received__",a="__esri_track_line__";var c;!function(e){e[e.TrackLine=0]="TrackLine",e[e.LatestObservation=1]="LatestObservation",e[e.PreviousObservation=2]="PreviousObservation"}(c||(c={}))},55431:(e,t,s)=>{s.d(t,{h:()=>n});s(7753),s(67134);var r=s(807),i=s(49684);s(96726),s(25242);function n(e,t,s){if(null==e?.timeInfo)return null;const{datesInUnknownTimezone:n=!1,timeOffset:o,useViewTime:a}=e;let c=e.timeExtent;n&&(c=function(e){if(!e)return e;const{start:t,end:s}=e;return new i.Z({start:null!=t?(0,r.Nm)(t,t.getTimezoneOffset(),"minutes"):t,end:null!=s?(0,r.Nm)(s,s.getTimezoneOffset(),"minutes"):s})}(c));let l=a?t&&c?t.intersection(c):t||c:c;return!l||l.isEmpty||l.isAllTime?l:(o&&(l=l.offset(-o.value,o.unit)),n&&(l=function(e){if(!e)return e;const{start:t,end:s}=e;return new i.Z({start:null!=t?(0,r.Nm)(t,-t.getTimezoneOffset(),"minutes"):t,end:null!=s?(0,r.Nm)(s,-s.getTimezoneOffset(),"minutes"):s})}(l)),l.equals(s)?s:l)}},51211:(e,t,s)=>{s.d(t,{Z:()=>b});var r,i=s(36663),n=s(80085),o=s(25709),a=s(82064),c=s(67134),l=s(81977),u=(s(39994),s(13802),s(34248)),h=s(40266),d=s(39835),p=s(14685),f=s(53736),_=s(59659),y=s(12512);const g=new o.X({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null});let m=r=class extends a.Z{constructor(e){super(e),this.displayFieldName=null,this.exceededTransferLimit=!1,this.features=[],this.fields=null,this.geometryType=null,this.hasM=!1,this.hasZ=!1,this.queryGeometry=null,this.spatialReference=null}readFeatures(e,t){return this.readFeaturesWithClass(e,t,n.Z)}writeGeometryType(e,t,s,r){if(e)return void g.write(e,t,s,r);const{features:i}=this;if(i)for(const e of i)if(null!=e?.geometry)return void g.write(e.geometry.type,t,s,r)}readQueryGeometry(e,t){if(!e)return null;const s=!!e.spatialReference,r=(0,f.im)(e);return r&&!s&&t.spatialReference&&(r.spatialReference=p.Z.fromJSON(t.spatialReference)),r}writeSpatialReference(e,t){if(e)return void(t.spatialReference=e.toJSON());const{features:s}=this;if(s)for(const e of s)if(e&&null!=e.geometry&&e.geometry.spatialReference)return void(t.spatialReference=e.geometry.spatialReference.toJSON())}clone(){return new r(this.cloneProperties())}cloneProperties(){return(0,c.d9)({displayFieldName:this.displayFieldName,exceededTransferLimit:this.exceededTransferLimit,features:this.features,fields:this.fields,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,queryGeometry:this.queryGeometry,spatialReference:this.spatialReference,transform:this.transform})}toJSON(e){const t=this.write();if(t.features&&Array.isArray(e)&&e.length>0)for(let s=0;s<t.features.length;s++){const r=t.features[s];if(r.geometry){const t=e?.[s];r.geometry=t?.toJSON()||r.geometry}}return t}quantize(e){const{scale:[t,s],translate:[r,i]}=e,n=this.features,o=this._getQuantizationFunction(this.geometryType,(e=>Math.round((e-r)/t)),(e=>Math.round((i-e)/s)));for(let e=0,t=n.length;e<t;e++)o?.(n[e].geometry)||(n.splice(e,1),e--,t--);return this.transform=e,this}unquantize(){const{geometryType:e,features:t,transform:s}=this;if(!s)return this;const{translate:[r,i],scale:[n,o]}=s;let a=null,c=null;if(this.hasZ&&null!=s?.scale?.[2]){const{translate:[,,e],scale:[,,t]}=s;a=s=>s*t+e}if(this.hasM&&null!=s?.scale?.[3]){const{translate:[,,,e],scale:[,,,t]}=s;c=s=>null==s?s:s*t+e}const l=this._getHydrationFunction(e,(e=>e*n+r),(e=>i-e*o),a,c);for(const{geometry:e}of t)null!=e&&l&&l(e);return this.transform=null,this}readFeaturesWithClass(e,t,s){const r=p.Z.fromJSON(t.spatialReference),i=[];for(let t=0;t<e.length;t++){const n=e[t],o=s.fromJSON(n),a=n.geometry?.spatialReference;null==o.geometry||a||(o.geometry.spatialReference=r);const c=n.aggregateGeometries,l=o.aggregateGeometries;if(c&&null!=l)for(const e in l){const t=l[e],s=c[e]?.spatialReference;null==t||s||(t.spatialReference=r)}i.push(o)}return i}_quantizePoints(e,t,s){let r,i;const n=[];for(let o=0,a=e.length;o<a;o++){const a=e[o];if(o>0){const e=t(a[0]),o=s(a[1]);e===r&&o===i||(n.push([e-r,o-i]),r=e,i=o)}else r=t(a[0]),i=s(a[1]),n.push([r,i])}return n.length>0?n:null}_getQuantizationFunction(e,t,s){return"point"===e?e=>(e.x=t(e.x),e.y=s(e.y),e):"polyline"===e||"polygon"===e?e=>{const r=(0,f.oU)(e)?e.rings:e.paths,i=[];for(let e=0,n=r.length;e<n;e++){const n=r[e],o=this._quantizePoints(n,t,s);o&&i.push(o)}return i.length>0?((0,f.oU)(e)?e.rings=i:e.paths=i,e):null}:"multipoint"===e?e=>{const r=this._quantizePoints(e.points,t,s);return r&&r.length>0?(e.points=r,e):null}:"extent"===e?e=>e:null}_getHydrationFunction(e,t,s,r,i){return"point"===e?e=>{e.x=t(e.x),e.y=s(e.y),r&&(e.z=r(e.z))}:"polyline"===e||"polygon"===e?e=>{const n=(0,f.oU)(e)?e.rings:e.paths;let o,a;for(let e=0,r=n.length;e<r;e++){const r=n[e];for(let e=0,i=r.length;e<i;e++){const i=r[e];e>0?(o+=i[0],a+=i[1]):(o=i[0],a=i[1]),i[0]=t(o),i[1]=s(a)}}if(r&&i)for(let e=0,t=n.length;e<t;e++){const t=n[e];for(let e=0,s=t.length;e<s;e++){const s=t[e];s[2]=r(s[2]),s[3]=i(s[3])}}else if(r)for(let e=0,t=n.length;e<t;e++){const t=n[e];for(let e=0,s=t.length;e<s;e++){const s=t[e];s[2]=r(s[2])}}else if(i)for(let e=0,t=n.length;e<t;e++){const t=n[e];for(let e=0,s=t.length;e<s;e++){const s=t[e];s[2]=i(s[2])}}}:"extent"===e?e=>{e.xmin=t(e.xmin),e.ymin=s(e.ymin),e.xmax=t(e.xmax),e.ymax=s(e.ymax),r&&null!=e.zmax&&null!=e.zmin&&(e.zmax=r(e.zmax),e.zmin=r(e.zmin)),i&&null!=e.mmax&&null!=e.mmin&&(e.mmax=i(e.mmax),e.mmin=i(e.mmin))}:"multipoint"===e?e=>{const n=e.points;let o,a;for(let e=0,r=n.length;e<r;e++){const r=n[e];e>0?(o+=r[0],a+=r[1]):(o=r[0],a=r[1]),r[0]=t(o),r[1]=s(a)}if(r&&i)for(let e=0,t=n.length;e<t;e++){const t=n[e];t[2]=r(t[2]),t[3]=i(t[3])}else if(r)for(let e=0,t=n.length;e<t;e++){const t=n[e];t[2]=r(t[2])}else if(i)for(let e=0,t=n.length;e<t;e++){const t=n[e];t[2]=i(t[2])}}:null}};(0,i._)([(0,l.Cb)({type:String,json:{write:!0}})],m.prototype,"displayFieldName",void 0),(0,i._)([(0,l.Cb)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],m.prototype,"exceededTransferLimit",void 0),(0,i._)([(0,l.Cb)({type:[n.Z],json:{write:!0}})],m.prototype,"features",void 0),(0,i._)([(0,u.r)("features")],m.prototype,"readFeatures",null),(0,i._)([(0,l.Cb)({type:[y.Z],json:{write:!0}})],m.prototype,"fields",void 0),(0,i._)([(0,l.Cb)({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:g.read}}})],m.prototype,"geometryType",void 0),(0,i._)([(0,d.c)("geometryType")],m.prototype,"writeGeometryType",null),(0,i._)([(0,l.Cb)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],m.prototype,"hasM",void 0),(0,i._)([(0,l.Cb)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],m.prototype,"hasZ",void 0),(0,i._)([(0,l.Cb)({types:_.qM,json:{write:!0}})],m.prototype,"queryGeometry",void 0),(0,i._)([(0,u.r)("queryGeometry")],m.prototype,"readQueryGeometry",null),(0,i._)([(0,l.Cb)({type:p.Z,json:{write:!0}})],m.prototype,"spatialReference",void 0),(0,i._)([(0,d.c)("spatialReference")],m.prototype,"writeSpatialReference",null),(0,i._)([(0,l.Cb)({json:{write:!0}})],m.prototype,"transform",void 0),m=r=(0,i._)([(0,h.j)("esri.rest.support.FeatureSet")],m),m.prototype.toJSON.isDefaultToJSON=!0;const b=m},25242:(e,t,s)=>{s.d(t,{x:()=>r});const r=Symbol("WebScene")},90488:(e,t,s)=>{s.r(t),s.d(t,{default:()=>Z});var r=s(36663),i=s(70375),n=s(76868),o=s(81977),a=(s(39994),s(13802),s(4157),s(40266)),c=s(80085),l=s(74396),u=s(61681),h=s(64189),d=s(59659),p=s(8774),f=s(8705),_=s(3659);let y=class extends c.Z{constructor(e){super(e)}getObjectId(){return this.objectId}};(0,r._)([(0,o.Cb)({type:Number,json:{read:!0}})],y.prototype,"objectId",void 0),y=(0,r._)([(0,a.j)("esri.layers.graphics.controllers.StreamController.StreamGraphic")],y);class g{constructor(e){this.onUpdate=e,this._idToGraphic=new Map}destroy(){this._idToGraphic.clear()}add(e){this._idToGraphic.set(e.objectId,e)}get(e){return this._idToGraphic.get(e)}forEach(e){this._idToGraphic.forEach(e)}removeById(e){const t=this._idToGraphic.get(e);return t?(t.sourceLayer=t.layer=null,this._idToGraphic.delete(e),t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._idToGraphic.size}}let m=class extends(h.Z.EsriPromiseMixin(l.Z)){constructor(){super(...arguments),this.isPaused=!1,this.graphics=new _.g,this._updateInfo={websocket:0,client:0},this._updateIntervalId=null,this._outSpatialReference=null}initialize(){this.addResolvingPromise(this.layer.when((()=>this._startup())))}destroy(){this.clear()}_clearInterval(){null!==this._updateIntervalId&&(clearInterval(this._updateIntervalId),this._updateIntervalId=null)}clear(){this._shutdown(),this.graphics.clear()}get updating(){return!this.connection||"connected"===this.connection.connectionStatus}_shutdown(){this._clearInterval(),this.connection=(0,u.SC)(this.connection),this.store=(0,u.SC)(this.store),this.removeAllHandles()}_startup(){const{layer:e,layerView:t}=this,{spatialReference:s,definitionExpression:r,geometryDefinition:i,objectIdField:o,timeInfo:a,purgeOptions:c,maxReconnectionAttempts:l,maxReconnectionInterval:u,customParameters:h}=e,_=e.geometryType?d.Mk.toJSON(e.geometryType):null,y=s,m=t.view.spatialReference;this.clear(),this._set("connection",(0,f.createConnection)(e.parsedUrl,y,m,_,r,i,l,u,h??void 0)),this._outSpatialReference=m.toJSON(),this.store=new g(this._onUpdate.bind(this)),this.featuresManager=new p.Q(this.store,o,a.toJSON(),c);const b="startup-watches";this.removeHandles(b),this.addHandles([e.on("send-message-to-socket",(e=>this.connection.sendMessageToSocket(e))),e.on("send-message-to-client",(e=>this.connection.sendMessageToClient(e))),this.connection.on("data-received",(e=>this._onFeature(e))),this.connection.on("message-received",(e=>this._onWebSocketMessage(e))),(0,n.watch)((()=>[e.definitionExpression,e.geometryDefinition,e.purgeOptions]),(()=>this._startup()))],b),this.isPaused||this._initUpdateInterval()}_onWebSocketMessage(e){if(this.layerView.emit("message-received",e),"type"in e)switch(e.type){case"delete":if(e.objectIds)for(const t of e.objectIds)this.featuresManager.removeById(t);if(e.trackIds)for(const t of e.trackIds)this.featuresManager.removeByTrackId(t);break;case"clear":this.store.forEach((e=>this.featuresManager.removeById(e.objectId)))}}_onFeature(e){this._updateInfo.websocket++,this.layerView.hasEventListener("data-received")&&this.layerView.emit("data-received",{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry});try{null==e.geometry||e.geometry.spatialReference||(e.geometry.spatialReference=this._outSpatialReference);const t=y.fromJSON(e);t.sourceLayer=t.layer=this.layer,this.featuresManager.add(t)}catch{}}_onUpdate(e,t){null!=t&&this.graphics.removeMany(t),null!=e&&(this._updateInfo.client+=e.length,this.graphics.addMany(e))}_initUpdateInterval(){this._clearInterval();const{updateInterval:e}=this.layer;let t=performance.now();this._updateIntervalId=setInterval((()=>{const e=performance.now(),s=e-t;if(s>2500){t=e;const r=Math.round(this._updateInfo.client/(s/1e3)),i=Math.round(this._updateInfo.websocket/(s/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.layerView.emit("update-rate",{client:r,websocket:i})}this.featuresManager.checkForUpdates()}),e)}pauseStream(){this.isPaused=!0,this._clearInterval()}resumeStream(){this.isPaused=!1,this._initUpdateInterval()}disconnect(){this._shutdown()}connect(){null==this.connection&&this._startup()}clearGraphics(){this.graphics.clear()}};(0,r._)([(0,o.Cb)()],m.prototype,"isPaused",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],m.prototype,"layer",void 0),(0,r._)([(0,o.Cb)({constructOnly:!0})],m.prototype,"layerView",void 0),(0,r._)([(0,o.Cb)()],m.prototype,"connection",void 0),(0,r._)([(0,o.Cb)({readOnly:!0})],m.prototype,"updating",null),m=(0,r._)([(0,a.j)("esri.layers.graphics.controllers.StreamController")],m);var b=s(14626),w=s(32646),v=s(14264),S=s(28800),C=s(81466);let I=class extends C.Q{constructor(e){super(e),this.suspendResumeExtentMode="computed"}get connection(){return this.controller?.connection}createController(){return new m({layer:this.layer,layerView:this.layerView})}beforeSetController(){}pause(){this.controller?.pauseStream()}resume(){this.controller?.resumeStream()}disconnect(){this.controller?.disconnect()}connect(){this.controller?.connect()}clear(){this.controller?.clearGraphics()}};(0,r._)([(0,o.Cb)()],I.prototype,"controller",void 0),(0,r._)([(0,o.Cb)()],I.prototype,"connection",null),(0,r._)([(0,o.Cb)()],I.prototype,"suspendResumeExtentMode",void 0),I=(0,r._)([(0,a.j)("esri.views.3d.layers.graphics.StreamGraphics3DGraphicsPipeline")],I);var k=s(53448),R=s(26216),O=s(85570);let x=class extends((0,O.Z)((0,v.R)((0,S.A)(R.Z)))){constructor(){super(...arguments),this.type="stream-3d",this.updatePolicy=k.j.ASYNC,this.hasZ=!0,this.hasM=!1,this.featureEffect=null}initialize(){this.addHandles((0,n.watch)((()=>this.suspended),(e=>{this.graphicsPipeline&&this._onSuspendedChange(e)})))}get connectionError(){const e=this.graphicsPipeline?.connection?.errorString;return e?new i.Z("stream-controller",e):null}createQuery(){return new b.Z({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryLatestObservations(e,t){return this.graphicsPipeline.graphicsQuery.executeQueryForLatestObservations(this._ensureQuery(e),t?.signal)}async queryObjectIds(e,t){return(await super.queryObjectIds(e,t)).filter(w.hj)}get _streamConnectionStatus(){return this.graphicsPipeline?.connection?.connectionStatus??"disconnected"}async createGraphicsPipeline(){return new I({layerView:this})}createController(){return new m({layer:this.layer,layerView:this})}beforeSetController(){}_doPause(){this.graphicsPipeline?.pause()}_doResume(){this.graphicsPipeline?.resume()}_doDisconnect(){this.graphicsPipeline?.disconnect(),this._doPause()}_doConnect(){this.graphicsPipeline?.connect(),this.resume()}_doClear(){this.graphicsPipeline?.clear()}};(0,r._)([(0,o.Cb)({readOnly:!0})],x.prototype,"updatePolicy",void 0),(0,r._)([(0,o.Cb)({readOnly:!0})],x.prototype,"connectionError",null),(0,r._)([(0,o.Cb)()],x.prototype,"graphicsPipeline",void 0),(0,r._)([(0,o.Cb)({readOnly:!0})],x.prototype,"hasZ",void 0),(0,r._)([(0,o.Cb)({readOnly:!0})],x.prototype,"hasM",void 0),(0,r._)([(0,o.Cb)()],x.prototype,"featureEffect",void 0),(0,r._)([(0,o.Cb)({readOnly:!0})],x.prototype,"_streamConnectionStatus",null),x=(0,r._)([(0,a.j)("esri.views.3d.layers.StreamLayerView3D")],x);const Z=x},85570:(e,t,s)=>{s.d(t,{Z:()=>a});var r=s(36663),i=s(81977),n=(s(39994),s(13802),s(4157),s(40266)),o=s(15553);const a=e=>{let t=class extends e{resume(){this._isUserPaused=!1,this.suspended||this._doResume()}pause(){this._isUserPaused=!0,this.suspended||this._doPause()}disconnect(){this._doDisconnect()}connect(){this._doConnect()}clear(){this._doClear()}constructor(...e){super(...e),this._isUserPaused=!1,this.filter=null}get connectionStatus(){return(this._isUserPaused||this.suspended)&&"connected"===this._streamConnectionStatus?"paused":this._streamConnectionStatus}_onSuspendedChange(e){e?this._doPause():this._isUserPaused||this._doResume()}};return(0,r._)([(0,i.Cb)()],t.prototype,"_isUserPaused",void 0),(0,r._)([(0,i.Cb)({readOnly:!0})],t.prototype,"connectionStatus",null),(0,r._)([(0,i.Cb)({type:o.Z})],t.prototype,"filter",void 0),t=(0,r._)([(0,n.j)("esri.views.layers.StreamLayerView")],t),t}}}]);