(self.webpackChunkarcgis_webpack01=self.webpackChunkarcgis_webpack01||[]).push([[7287],{4688:(e,t,i)=>{"use strict";i.d(t,{Z:()=>r});var s=i(59472);const r=class{constructor(e=Number.POSITIVE_INFINITY){this.size=0,this._start=0,this.maxSize=e,this._buffer=isFinite(e)?new Array(e):[]}get entries(){return this._buffer}enqueue(e){if(this.size===this.maxSize){const t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return isFinite(this.maxSize)?this._buffer[(this._start+this.size++)%this.maxSize]=e:this._buffer[this._start+this.size++]=e,null}dequeue(){if(0===this.size)return null;const e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}peek(){return 0===this.size?null:this._buffer[this._start]}find(e){if(0===this.size)return null;for(const t of this._buffer)if((0,s.pC)(t)&&e(t))return t;return null}clear(e){let t=this.dequeue();for(;(0,s.pC)(t);)e&&e(t),t=this.dequeue()}}},41419:(e,t,i)=>{"use strict";i.d(t,{t:()=>r});var s=i(36654);async function r(e,t){const{data:i}=await(0,s.default)(e,{responseType:"image",...t});return i}},11426:(e,t,i)=>{"use strict";i.d(t,{Z:()=>o});var s=i(19546),r=i(90169),n=i(36889),a=i(71108);const o=class{dispose(){this._rasterizationCanvas=null}rasterizeJSONResource(e,t,i){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),"simple-fill"===e.type||"esriSFS"===e.type){const[i,s,r]=n.fN.rasterizeSimpleFill(this._rasterizationCanvas,e.style,t);return{size:[s,r],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0}}if("simple-line"===e.type||"esriSLS"===e.type){const[t,i,s]=n.fN.rasterizeSimpleLine(e.style,e.cap);return{size:[i,s],image:new Uint32Array(t.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let s,o,h;if("simple-marker"===e.type||"esriSMS"===e.type||"line-marker"===e.type?(s=n.B$.fromSimpleMarker(e),h=(0,a.Fp)(s)):"CIMHatchFill"===e.type?(s=n.B$.fromCIMHatchFill(e),o=new r.Z(s.frame.xmin,-s.frame.ymax,s.frame.xmax-s.frame.xmin,s.frame.ymax-s.frame.ymin)):e.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===e.markerPlacement.type?(s=n.B$.fromCIMInsidePolygon(e),o=new r.Z(s.frame.xmin,-s.frame.ymax,s.frame.xmax-s.frame.xmin,s.frame.ymax-s.frame.ymin)):(s=e,h=(0,a.Fp)(s)),h&&!i){const[e,t,i]=(0,a.RL)(h);return e?{size:[t,i],image:new Uint32Array(e.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}const[l,d,u,c,m]=n.B$.rasterize(this._rasterizationCanvas,s,o,!i);return l?{size:[d,u],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:c,anchorY:m}:null}rasterizeImageResource(e,t,i,r){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const n=this._rasterizationCanvas.getContext("2d");i instanceof ImageData?n.putImageData(i,0,0):(i.setAttribute("width",`${e}px`),i.setAttribute("height",`${t}px`),n.drawImage(i,0,0,e,t));const a=n.getImageData(0,0,e,t),o=new Uint8Array(a.data);if(r)for(const e of r)if(e&&e.oldColor&&4===e.oldColor.length&&e.newColor&&4===e.newColor.length){const[t,i,s,r]=e.oldColor,[n,a,h,l]=e.newColor;if(t===n&&i===a&&s===h&&r===l)continue;for(let e=0;e<o.length;e+=4)t===o[e]&&i===o[e+1]&&s===o[e+2]&&r===o[e+3]&&(o[e]=n,o[e+1]=a,o[e+2]=h,o[e+3]=l)}let h;for(let e=0;e<o.length;e+=4)h=o[e+3]/255,o[e]=o[e]*h,o[e+1]=o[e+1]*h,o[e+2]=o[e+2]*h;let l=o,d=e,u=t;const c=512;if(d>=c||u>=c){const i=d/u;i>1?(d=c,u=Math.round(c/i)):(u=c,d=Math.round(c*i)),l=new Uint8Array(4*d*u);const r=new Uint8ClampedArray(l.buffer);(0,s.TT)(o,e,t,r,d,u,!1)}return{size:[e,t],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}},90200:(e,t,i)=>{"use strict";i.d(t,{Ki:()=>l,Ao:()=>d,yB:()=>h,Hn:()=>a,GF:()=>o});var s=i(33655),r=i(21252),n=i(71286);const a=0,o=1,h=2;class l{constructor(e,t){this.width=e,this.height=t;const i=Math.ceil(e/1),s=Math.ceil(t/1);this._cols=i,this._rows=s,this._cells=r.p.create(i*s)}insertMetrics(e){const t=this._hasCollision(e);return t===a&&this._markMetrics(e),t}getCellId(e,t){return e+t*this._cols}has(e){return this._cells.has(e)}hasRange(e,t){return this._cells.hasRange(e,t)}set(e){this._cells.set(e)}setRange(e,t){this._cells.setRange(e,t)}_hasCollision(e){const t=e.id;let i=0,s=0;e.save();do{const t=e.boundsCount;i+=t;for(let i=0;i<t;i++){const t=e.boundsComputedAnchorX(i),r=e.boundsComputedAnchorY(i),n=e.boundsWidth(i)+2,a=e.boundsHeight(i)+2;switch(this._collide(t,r,n,a)){case h:return h;case o:s++}}}while(e.peekId()===t&&e.next());return e.restore(),i===s?o:a}_collide(e,t,i,r){const n=e-i/2,l=e+i/2,d=t-r/2,u=t+r/2;if(l<0||u<0||n>this.width||d>this.height)return o;const c=(0,s.uZ)(Math.floor(n/1),0,this._cols),m=(0,s.uZ)(Math.floor(d/1),0,this._rows),p=(0,s.uZ)(Math.ceil(l/1),0,this._cols),_=(0,s.uZ)(Math.ceil(u/1),0,this._rows);for(let e=m;e<=_;e++)for(let t=c;t<=p;t++){const i=this.getCellId(t,e);if(this.has(i))return h}return a}_mark(e,t,i,r){const n=e-i/2,a=e+i/2,o=t-r/2,h=t+r/2,l=(0,s.uZ)(Math.floor(n/1),0,this._cols),d=(0,s.uZ)(Math.floor(o/1),0,this._rows),u=(0,s.uZ)(Math.ceil(a/1),0,this._cols),c=(0,s.uZ)(Math.ceil(h/1),0,this._rows);for(let e=d;e<=c;e++)for(let t=l;t<=u;t++){const i=this.getCellId(t,e);this.set(i)}return!1}_markMetrics(e){const t=e.id;do{const t=e.boundsCount;for(let i=0;i<t;i++){const t=e.boundsComputedAnchorX(i),s=e.boundsComputedAnchorY(i),r=e.boundsWidth(i)+2,n=e.boundsHeight(i)+2;this._mark(t,s,r,n)}}while(e.peekId()===t&&e.next())}}class d{constructor(e,t=2){this._bucketSize=e,this._rowsLength=n.I_/e,this._colsLength=n.I_/e,this._elementsPerBucket=t,this._grid=this._initGrid()}checkOverlap(e,t){const i=Math.floor(e/this._bucketSize),s=Math.floor(t/this._bucketSize);return i<0||i>=this._rowsLength||s<0||s>=this._colsLength||this._grid[s*this._colsLength+i]>=this._elementsPerBucket}markUsed(e,t){const i=Math.floor(e/this._bucketSize),s=Math.floor(t/this._bucketSize);this._grid[s*this._colsLength+i]+=1}reset(){this._grid=this._initGrid()}_initGrid(){return new Uint8Array(this._rowsLength*this._colsLength)}}},24989:(e,t,i)=>{"use strict";i.d(t,{Z:()=>a});var s=i(31514),r=i(61343);class n extends r.Z{renderChildren(e){this.attributeView.bindTextures(e.context),this.children.some((e=>e.hasData))&&(super.renderChildren(e),e.drawPhase===s.jx.MAP&&this._renderChildren(e),e.drawPhase===s.jx.HIGHLIGHT&&this._renderHighlight(e))}_renderHighlight(e){const{painter:t}=e,i=t.effects.highlight;i.bind(e),this._renderChildren(e,i.defines),i.draw(e),i.unbind()}}const a=n},77287:(e,t,i)=>{"use strict";i.r(t),i.d(t,{GraphicContainer:()=>bi.Z,GraphicsView2D:()=>wi.Z,LabelManager:()=>L,MagnifierView2D:()=>ts,MapViewNavigation:()=>Ki,Stage:()=>yi});var s=i(56140),r=i(95830),n=i(36544),a=(i(68055),i(79881)),o=i(87566),h=i(32656),l=i(10923),d=(i(57002),i(86035),i(79152)),u=i(77204),c=i(69065),m=i(59472),p=i(71286),_=i(90200),f=i(33655),g=i(96071),v=i(2961);const y=Math.PI;function w(e,t){switch(t.transformationType){case"additive":return function(e,t){return e+(b(t.minSize,e)||t.minDataValue)}(e,t);case"constant":return function(e,t){const i=e.stops;let s=i&&i.length&&i[0].size;return null==s&&(s=e.minSize),b(s,t)}(t,e);case"clamped-linear":return function(e,t){const i=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),s=b(t.minSize,e),r=b(t.maxSize,e);return e<=t.minDataValue?s:e>=t.maxDataValue?r:s+i*(r-s)}(e,t);case"proportional":return function(e,t){const i=e/t.minDataValue,s=b(t.minSize,e),r=b(t.maxSize,e);let n=null;return n=i*s,(0,f.uZ)(n,s,r)}(e,t);case"stops":return function(e,t){const[i,s,r]=function(e,t){if(!t)return;let i=0,s=t.length-1;return t.some(((t,r)=>e<t?(s=r,!0):(i=r,!1))),[i,s,(e-t[i])/(t[s]-t[i])]}(e,t.cache.ipData);if(i===s)return b(t.stops[i].size,e);{const n=b(t.stops[i].size,e);return n+(b(t.stops[s].size,e)-n)*r}}(e,t);case"real-world-size":return function(e,t){const i=v.a[t.valueUnit],s=b(t.minSize,e),r=b(t.maxSize,e),{valueRepresentation:n}=t;let a=null;return a="area"===n?2*Math.sqrt(e/y)/i:"radius"===n||"distance"===n?2*e/i:e/i,(0,f.uZ)(a,s,r)}(e,t);case"identity":return e;case"unknown":return null}}function b(e,t){return"number"==typeof e?e:w(t,e)}const x=(e,t)=>e.order-t.order,C=(e,t)=>e.index-t.index,M=n.Z.getLogger("esri/views/2d/engine/webgl/collisions/CollisionEngine");function T(e,t){const i=!!e.minScale,s=!!e.maxScale,r=i&&t.scaleToZoom(e.minScale)||0,n=s&&t.scaleToZoom(e.maxScale)||255;return{deconflictionStrategy:e.deconflictionStrategy,minZoom:(0,f.uZ)(Math.floor(10*r),0,255),maxZoom:(0,f.uZ)(Math.floor(10*n),0,255)}}function S(e){return t=>(0,g.F2)(w(t,e))}function F(e){if(!e)return null;for(const t of e)if("size"===t.type)return S(t);return null}class P{constructor(e,t,i,s){this._vvHandle=null;const r=e.layer,{geometryType:n,labelingInfo:a,renderer:o}=r;o&&(this.vvEval=F("visualVariables"in o&&o.visualVariables)),this._vvHandle=r.watch("renderer",(e=>{e&&(this.vvEval=F("visualVariables"in e&&e.visualVariables))}));const h=r.featureReduction,l=h&&"cluster"===h.type&&h.labelingInfo,d=(a||[]).map((e=>T(e,s))),u=(l||[]).map((e=>T(e,s)));this.layerView=e,this.geometryType=n,this.index=t,this.order=i,this.zoomRanges=[...d,...u],this.layerView=e}hasVV(){return!!this.vvEval}allOrNothing(){return!("polyline"===this.geometryType)}destroy(){this._vvHandle.remove()}static create(e,t,i,s){const r=i.sort(x);let n=!1,a=-1;for(const e of r)!n&&e.order>t&&(a=e.index,n=!0),n&&e.index++;return n||(a=r.length),new P(e,a,t,s)}static delete(e,t){const i=t.sort(C);for(let s=e+1;s<i.length;s++)t[s].index--;t[e].destroy(),t.splice(e,1)}static find(e,t){for(const i of t)if(i.index===e)return i;return M.error("Tried to get a LayerCollisionInfo for an index that doesn't exist!"),null}}const R=P;function z(e,t){const i=[];e.forEachTile((e=>i.push(e))),i.sort(((e,t)=>e.instanceId-t.instanceId)),i.forEach((e=>{(0,m.pC)(e.labelMetrics)&&e.isReady&&t(e,e.labelMetrics.getCursor())}))}class I{constructor(e){this._layers=new Map,this._tilingScheme=e}get collisionInfos(){return Array.from(this._layers.values())}registerLayerView(e,t){if(this._layers.has(e))return;const i=R.create(e,t,this.collisionInfos,this._tilingScheme);this._layers.set(e,i)}unregisterLayerView(e){if(!this._layers.has(e))return;const t=this._layers.get(e);R.delete(t.index,this.collisionInfos),this._layers.delete(e)}run(e,t){this._transformMetrics(e),this._runCollision(e,t)}_runCollision(e,t){const[i,s]=e.state.size,r=new _.Ki(i,s);this._forEachLayer(((e,i)=>{const s=e.zoomRanges.some((e=>"none"===e.deconflictionStrategy)),n=i.featuresView.attributeView;s?z(i,((e,t)=>{for(;t.nextId();)n.setLabelMinZoom(t.id,0)})):(this._prepare(i),this._collideVisible(r,i,t),this._collideInvisible(r,i))}))}_isFiltered(e,t,i){const s=t.getFilterFlags(e),r=!i.hasFilter||!!(s&p.Zd),n=!i.effect||i.effect.excludedLabelsVisible||!!(s&p.iV);return!(r&&n)}_prepare(e){const t=e.featuresView.attributeView,i=new Set;z(e,((s,r)=>{for(;r.nextId();)i.has(r.id)||(i.add(r.id),this._isFiltered(r.id,t,e.layerView)?t.setLabelMinZoom(r.id,254):0!==t.getLabelMinZoom(r.id)?t.setLabelMinZoom(r.id,255):t.setLabelMinZoom(r.id,0))}))}_collideVisible(e,t,i){const s=t.featuresView.attributeView,r=new Set;z(t,((t,n)=>{for(;n.nextId();)if(!r.has(n.id))if(t.key.level===i){if(0===s.getLabelMinZoom(n.id))switch(e.insertMetrics(n)){case _.GF:break;case _.yB:s.setLabelMinZoom(n.id,254),r.add(n.id);break;case _.Hn:s.setLabelMinZoom(n.id,0),r.add(n.id)}}else s.setLabelMinZoom(n.id,254)}))}_collideInvisible(e,t){const i=t.featuresView.attributeView,s=new Set;z(t,((t,r)=>{for(;r.nextId();)if(!s.has(r.id)&&255===i.getLabelMinZoom(r.id))switch(e.insertMetrics(r)){case _.GF:break;case _.yB:i.setLabelMinZoom(r.id,255),s.add(r.id);break;case _.Hn:i.setLabelMinZoom(r.id,0),s.add(r.id)}}))}_transformMetrics(e){this._forEachLayer(((t,i)=>{z(i,((s,r)=>{const n=i.featuresView.attributeView,a=s.transforms.labelMat2d;a[4]=Math.round(a[4]),a[5]=Math.round(a[5]);const o=a[4],h=a[5],l="polyline"===t.geometryType;for(;r.next();){const i=r.boundsCount,s=r.anchorX,d=r.anchorY;let u=0,c=0;if(t.hasVV()){const e=n.getVVSize(r.id),i=t.vvEval(e),s=isNaN(i)||null==i||i===1/0?r.size:i;u=r.directionX*(s/2),c=r.directionY*(s/2)}for(let t=0;t<i;t++){let i=s,n=r.anchorY;if(l){let s=i+r.boundsCenterX(t)+u,l=n+r.boundsCenterY(t)+c;e.state.rotation?(s=a[0]*s+a[2]*l+a[4],l=a[1]*s+a[3]*l+a[5]):(s+=o,l+=h),r.setBoundsComputedAnchorX(t,Math.floor(s)),r.setBoundsComputedAnchorY(t,Math.floor(l))}else{e.state.rotation?(i=a[0]*s+a[2]*d+a[4],n=a[1]*s+a[3]*d+a[5]):(i+=o,n+=h);const l=i+r.boundsCenterX(t)+u,m=n+r.boundsCenterY(t)+c;r.setBoundsComputedAnchorX(t,l),r.setBoundsComputedAnchorY(t,m)}}}}))}))}_forEachLayer(e){const t=[];this._layers.forEach((e=>t.push(e))),t.sort(((e,t)=>e.order-t.order)),t.forEach((t=>{var i;const s=null==(i=t.layerView)?void 0:i.tileRenderer;s&&e(t,s)}))}}const D=n.Z.getLogger("esri.views.2d.engine.collisions.LayerViewSorter");function B(e){return"esri.views.2d.layers.FeatureLayerView2D"===e.declaredClass||"esri.views.2d.layers.StreamLayerView2D"===e.declaredClass}function O(e){if(!e.layer||!e.layer.renderer)return!1;switch(e.layer.renderer.type){case"class-breaks":case"simple":case"unique-value":case"dictionary":case"dot-density":return!0;default:return D.error(new h.Z("mapview-labeling",`Renderer of type ${e.layer.renderer.type} does not currently support labeling`)),!1}}class E{constructor(e,t){this.registerLayer=e,this.unregisterLayer=t,this._layerViewState=new Map}findIndex(e){return e.view.allLayerViews.findIndex((t=>t.uid===e.uid))}update(e){const{added:t,removed:i}=e;for(const e of i)B(e)&&this._layerViewState.has(e)&&this._deleteState(e);for(const e of t)B(e)&&O(e)&&!this._layerViewState.has(e)&&this._createState(e);this._recomputeOrder()}destroy(){this._layerViewState.forEach((e=>e.handles.forEach((e=>e.remove()))))}_createState(e){const t={priority:-1,handles:null};return t.handles=[e.layer.watch("visible",this._recomputeOrder.bind(this)),e.layer.watch("labelsVisible",this._recomputeOrder.bind(this)),e.layer.watch("labelingInfo",this._recomputeOrder.bind(this)),e.layer.watch("featureReduction",this._recomputeOrder.bind(this))],this._layerViewState.set(e,t),t}_deleteState(e){if(!this._layerViewState.has(e))return;const t=this._layerViewState.get(e);t.handles.forEach((e=>e.remove())),-1!==t.priority&&this.unregisterLayer(e),this._layerViewState.delete(e)}_recomputeOrder(){this._layerViewState.forEach(((e,t)=>{const i=t.view.map.allLayers.findIndex((e=>e.uid===t.layer.uid)),s=t.layer,r=s.featureReduction,n=r&&"cluster"===r.type&&r.labelsVisible&&r.labelingInfo&&r.labelingInfo.length,a=s.labelsVisible&&s.labelingInfo&&s.labelingInfo.length||n,o=s.visible&&a?4294967295-i:-1;o!==e.priority&&(e.priority=o,this.unregisterLayer(t),-1!==o&&this.registerLayer(t,o))}))}}const A=n.Z.getLogger("esri.views.2d.layers.labels.LabelManager");let k=class extends((0,u.p)(d.Z)){constructor(e){super(e),this._applyVisibilityPassThrottled=(0,c.P)(this._applyVisibilityPass,32,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new I(this.view.featuresTilingScheme),this._layerViewSorter=new E(((e,t)=>{this.collisionEngine.registerLayerView(e,t),this.requestUpdate()}),(e=>{this.collisionEngine.unregisterLayerView(e),this.requestUpdate()})),this.handles.add(this.view.allLayerViews.on("change",(e=>{this._layerViewSorter.update(e)})))}destroy(){this._layerViewSorter.destroy(),this._layerViewSorter=null,this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(e){this._applyVisibilityPassThrottled(e)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(e){this._set("updateParameters",e),this.updateRequested&&(this.updateRequested=!1,this.update(e))}_applyVisibilityPass(e){try{const t=this.view.featuresTilingScheme.getClosestInfoForScale(e.state.scale).level;this.collisionEngine.run(e,t)}catch(e){A.error(new h.Z("mapview-labeling","Encountered an error during label decluttering",e))}}};(0,s._)([(0,a.Cb)()],k.prototype,"updateRequested",void 0),(0,s._)([(0,a.Cb)({readOnly:!0})],k.prototype,"updateParameters",void 0),(0,s._)([(0,a.Cb)()],k.prototype,"updating",null),(0,s._)([(0,a.Cb)()],k.prototype,"view",void 0),k=(0,s._)([(0,o.j)("esri.views.2d.layers.labels.LabelManager")],k);const L=k;var U=i(10180),V=i(74386),Z=i(60418),H=i(80621),N=i(55735),W=i(17288),q=i(14286),G=i(27938),$=i(42738),j=i(75384),K=i(90461),Y=(i(5627),i(69595)),X=i(74038),Q=i(84570),J=i(22212),ee=i(89930),te=i(31514),ie=i(17149),se=(i(23660),i(29581)),re=i(32825),ne=i(51007),ae=i(65025);const oe={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform mediump vec2 u_pattern_tl;\nuniform mediump vec2 u_pattern_br;\nuniform sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main() {\n#ifdef PATTERN\n  mediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\n  mediump vec2 samplePos = mix(u_pattern_tl, u_pattern_br, normalizedTextureCoord);\n  lowp vec4 color = texture2D(u_texture, samplePos);\n  gl_FragColor = u_opacity * color;\n#else\n  gl_FragColor = u_color;\n#endif\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\n#endif\nvoid main() {\n  gl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\n  v_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\n#endif\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\n  mediump float dist = length(v_offset);\n  mediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\n  lowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\n  gl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\n  v_color = color * opacity;\n  v_stroke_color = stroke_color * stroke_opacity;\n  v_stroke_width = stroke_width;\n  v_radius = radius;\n  v_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\n  mediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\n  v_offset = offset;\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform mediump vec2 u_pattern_tl;\nuniform mediump vec2 u_pattern_br;\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\n  float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\n  vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\n  return vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\n  mediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\n  mediump vec2 samplePos = mix(u_pattern_tl, u_pattern_br, normalizedTextureCoord);\n  lowp vec4 color = texture2D(u_texture, samplePos);\n  gl_FragColor = v_color[3] * color;\n#else\n  gl_FragColor = v_color;\n#endif\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\n  v_color = color * opacity;\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n#ifdef PATTERN\n  v_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\n#endif\n  vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\n  float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\n  vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\n  return vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\n  lowp vec4 fillPixelColor = v_color;\n  float d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\n  const float softEdgeRatio = 0.248062016;\n  float size = max(v_size.x, v_size.y);\n  float dist = d * softEdgeRatio * size;\n  fillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\n  if (v_halo_width > 0.25) {\n    lowp vec4 outlinePixelColor = u_outlineColor;\n    const float outlineLimitRatio = (16.0 / 86.0);\n    float clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\n    outlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\n    gl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n  }\n  else {\n    gl_FragColor = v_opacity * fillPixelColor;\n  }\n#else\n  lowp vec4 texColor = texture2D(u_texture, v_tex);\n  gl_FragColor = v_opacity * texColor;\n#endif\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\n  v_color = color;\n  v_opacity = opacity;\n#ifdef SDF\n  v_halo_width = halo_width;\n#endif\n  float modded = mod(a_opacityInfo, 128.0);\n  float targetOpacity = (a_opacityInfo - modded) / 128.0;\n  float startOpacity = modded / 127.0;\n  float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\n  v_opacity *= interpolatedOpacity;\n  mediump float a_angle         = a_levelInfo[1];\n  mediump float a_minLevel      = a_levelInfo[2];\n  mediump float a_maxLevel      = a_levelInfo[3];\n  mediump vec2 a_tex            = a_texAngleRange.xy;\n  mediump float delta_z = 0.0;\n  mediump float rotated = mod(a_angle + u_mapRotation, 256.0);\n  delta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\n  delta_z += 1.0 - step(a_minLevel, u_level);\n  delta_z += step(a_maxLevel, u_level);\n  delta_z += step(v_opacity, 0.0);\n  vec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\n  v_size = abs(offset);\n#ifdef SDF\n  offset = (120.0 / 86.0) * offset;\n#endif\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n  v_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"varying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#ifdef PATTERN\nuniform mediump vec2 u_pattern_tl;\nuniform mediump vec2 u_pattern_br;\nuniform mediump vec2 u_spriteSize;\nuniform sampler2D u_texture;\nconst mediump float tileCoordRatio = 8.0;\n#else\nvarying mediump vec2 v_dasharray;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\n  mediump float fragDist = length(v_normal) * v_lineHalfWidth;\n  lowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\n  mediump float relativeTexX = mod((v_accumulatedDistance + v_normal.x * v_lineHalfWidth * tileCoordRatio) / u_spriteSize.x, 1.0);\n  mediump float relativeTexY = 0.5 + (v_normal.y * v_lineHalfWidth / u_spriteSize.y);\n  mediump vec2 texCoord = mix(u_pattern_tl, u_pattern_br, vec2(relativeTexX, relativeTexY));\n  lowp vec4 color = texture2D(u_texture, texCoord);\n  gl_FragColor = alpha * v_color[3] * color;\n#else\n  lowp float dashPos =  mod(v_accumulatedDistance, v_dasharray.x + v_dasharray.y);\n  lowp float dashAlpha = clamp(min(dashPos, v_dasharray.x - dashPos) + 0.5, 0.0, 1.0);\n  dashAlpha = max(sign(-v_dasharray.y), dashAlpha);\n  alpha *= dashAlpha;\n  gl_FragColor = alpha * v_color;\n#endif\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","line.vert":"attribute vec2 a_pos;\nattribute vec4 a_offsetAndNormal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\n#ifndef PATTERN\nuniform mediump vec2 u_dasharray;\nvarying mediump vec2 v_dasharray;\n#endif\nvoid main()\n{\n#pragma main\n  v_color = color * opacity;\n  v_blur = blur + u_antialiasing;\n  v_normal = a_offsetAndNormal.zw * scale;\n  v_lineHalfWidth += (width + u_antialiasing) * 0.5;\n#ifndef PATTERN\n  v_dasharray = u_dasharray * width;\n#endif\n  mediump vec2 dist = v_lineHalfWidth * scale * a_offsetAndNormal.xy;\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) +  u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth, 1.0);\n  v_accumulatedDistance = a_accumulatedDistance.x;\n  #ifdef ID\n    v_id = u_id / 255.0;\n  #endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\n  lowp float dist = abs(v_normal.y);\n  lowp float alpha = smoothstep(1.0, 0.0, dist);\n  gl_FragColor = alpha * v_color;\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\n  v_color = color * opacity;\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n  v_normal = a_xnormal;\n  mediump vec2 dist = u_outline_width * scale * a_offset;\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\n  lowp float dist = texture2D(u_texture, v_tex).a;\n  mediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\n  gl_FragColor = alpha * v_color;\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\n  if (u_halo > 0.5)\n  {\n    v_color = halo_color * opacity;\n    halo_width *= sdfPixel;\n    halo_blur *= sdfPixel;\n  }\n  else\n  {\n    v_color = color * opacity;\n    halo_width = 0.0;\n    halo_blur = 0.0;\n  }\n  float modded = mod(a_opacityInfo, 128.0);\n  float targetOpacity = (a_opacityInfo - modded) / 128.0;\n  float startOpacity = modded / 127.0;\n  float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\n  v_color *= interpolatedOpacity;\n  mediump float a_angle       = a_levelInfo[1];\n  mediump float a_minLevel    = a_levelInfo[2];\n  mediump float a_maxLevel    = a_levelInfo[3];\n  mediump vec2 a_tex          = a_texAngleRange.xy;\n  mediump float a_visMinAngle    = a_texAngleRange.z;\n  mediump float a_visMaxAngle    = a_texAngleRange.w;\n  mediump float delta_z = 0.0;\n  mediump float angle = mod(a_angle + u_mapRotation, 256.0);\n  if (a_visMinAngle < a_visMaxAngle)\n  {\n    delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n  }\n  else\n  {\n    delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n  }\n  delta_z += 1.0 - step(a_minLevel, u_level);\n  delta_z += step(a_maxLevel, u_level);\n  delta_z += step(v_color[3], 0.0);\n  v_tex = a_tex.xy / u_mosaicSize;\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n  v_edgeDistance = edgePos - halo_width / size;\n  v_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n    255.0 / (256.0),\n    255.0 / (256.0 * 256.0),\n    255.0 / (256.0 * 256.0 * 256.0),\n    255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n  );\nfloat rgba2float(vec4 rgba) {\n  return dot(rgba, rgba2float_factors);\n}"}},he=new ae.Z((function(e){let t=oe;return e.split("/").forEach((e=>{t&&(t=t[e])})),t}));function le(e){return he.resolveIncludes(e)}const de=e=>(0,J.K)({ID:e.id,PATTERN:e.pattern}),ue={shaders:e=>({vertexShader:de(e)+le("background/background.vert"),fragmentShader:de(e)+le("background/background.frag")})},ce=e=>(0,J.K)({ID:e.id}),me={shaders:e=>({vertexShader:ce(e)+le("circle/circle.vert"),fragmentShader:ce(e)+le("circle/circle.frag")})},pe=e=>(0,J.K)({ID:e.id,PATTERN:e.pattern}),_e={shaders:e=>({vertexShader:pe(e)+le("fill/fill.vert"),fragmentShader:pe(e)+le("fill/fill.frag")})},fe=e=>(0,J.K)({ID:e.id}),ge={shaders:e=>({vertexShader:fe(e)+le("outline/outline.vert"),fragmentShader:fe(e)+le("outline/outline.frag")})},ve=e=>(0,J.K)({ID:e.id,SDF:e.sdf}),ye={shaders:e=>({vertexShader:ve(e)+le("icon/icon.vert"),fragmentShader:ve(e)+le("icon/icon.frag")})},we=e=>(0,J.K)({ID:e.id,PATTERN:e.pattern}),be={shaders:e=>({vertexShader:we(e)+le("line/line.vert"),fragmentShader:we(e)+le("line/line.frag")})},xe=e=>(0,J.K)({ID:e.id}),Ce={shaders:e=>({vertexShader:xe(e)+le("text/text.vert"),fragmentShader:xe(e)+le("text/text.frag")})};var Me=i(58416);const Te={shaders:{vertexShader:(0,Me.w)("bitBlit/bitBlit.vert"),fragmentShader:(0,Me.w)("bitBlit/bitBlit.frag")},attributes:{a_pos:0,a_tex:1}};class Se{constructor(){this._initialized=!1}dispose(){this._program&&(this._program.dispose(),this._program=null),this._vertexArrayObject&&(this._vertexArrayObject.dispose(),this._vertexArrayObject=null)}render(e,t,i,s){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(1,771,1,771),e.bindVAO(this._vertexArrayObject),e.bindProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",s),e.drawArrays(5,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const t=Te.attributes,i=(0,J.H)(e,Te);if(!i)return!1;const s=new Int8Array(16);s[0]=-1,s[1]=-1,s[2]=0,s[3]=0,s[4]=1,s[5]=-1,s[6]=1,s[7]=0,s[8]=-1,s[9]=1,s[10]=0,s[11]=1,s[12]=1,s[13]=1,s[14]=1,s[15]=1;const r=new X.Z(e,t,{geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:4,normalized:!1,divisor:0},{name:"a_tex",count:2,type:5120,offset:2,stride:4,normalized:!1,divisor:0}]},{geometry:Y.Z.createVertex(e,35044,s)});return this._program=i,this._vertexArrayObject=r,this._initialized=!0,!0}}var Fe=i(99356);const Pe=e=>{let t="";t+=e[0].toUpperCase();for(let i=1;i<e.length;i++){const s=e[i];s===s.toUpperCase()?(t+="_",t+=s):t+=s.toUpperCase()}return t},Re=e=>{const t={};for(const i in e)t[Pe(i)]=e[i];return(0,J.K)(t)},ze=(e,t,i)=>{const s=e+e.substring(e.lastIndexOf("/")),r=t+t.substring(t.lastIndexOf("/"));return{attributes:i,shaders:e=>({vertexShader:Re(e)+(0,Me.w)(`${s}.vert`),fragmentShader:Re(e)+(0,Me.w)(`${r}.frag`)})}},Ie=e=>e===te.jx.HITTEST||e===te.jx.LABEL_ALPHA;var De=i(34926),Be=i(39105),Oe=i(36654),Ee=i(27851),Ae=i(9512),ke=i(84767),Le=i(11426),Ue=i(8634),Ve=i(89998);const Ze=class{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new Ve.Z(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new Ve.Z;let i=null,s=-1;for(let r=0;r<this._free.length;++r){const n=this._free[r];e<=n.width&&t<=n.height&&(null===i||n.y<=i.y&&n.x<=i.x)&&(i=n,s=r)}return null===i?new Ve.Z:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new Ve.Z(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new Ve.Z(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new Ve.Z(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new Ve.Z(i.x,i.y+t,e,i.height-t))),new Ve.Z(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}},He=e=>Math.floor(e/256);var Ne=i(90011);class We{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const t=e.getMessage();for(;t.next();)switch(t.tag()){case 3:{const e=t.getMessage();let i,s,r,n,a,o,h;for(;e.next();)switch(e.tag()){case 1:i=e.getUInt32();break;case 2:s=e.getBytes();break;case 3:r=e.getUInt32();break;case 4:n=e.getUInt32();break;case 5:a=e.getSInt32();break;case 6:o=e.getSInt32();break;case 7:h=e.getUInt32();break;default:e.skip()}e.release(),i&&(this._metrics[i]={width:r,height:n,left:a,top:o,advance:h},this._bitmaps[i]=s);break}default:t.skip()}t.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class qe{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}const Ge=[1,256,65536,16777216],$e=[1/256,1/65536,1/16777216,1/4294967296],je=function(e,t=0){let i=0;for(let s=0;s<4;s++)i+=e[t+s]*$e[s];return i}(new Uint8ClampedArray([255,255,255,255]));function Ke(e,t,i=0){const s=(n=je,(r=e)<0?0:r>n?n:r);var r,n;for(let e=0;e<4;e++)t[i+e]=Math.floor(256*Ye(s*Ge[e]))}function Ye(e){return e-Math.floor(e)}const Xe=1e20;var Qe=i(96540);function Je(e){return e&&"static"===e.type}class et{constructor(e,t,i,s=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(t<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,this._requestRender=e,s>0&&(this._maxItemSize=s),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new Ze(this._pageWidth,this._pageHeight);const r=Math.floor(this._pageWidth),n=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(r*n)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,t,i,s,r,n){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let a,o,h;if(Je(i))[a,o,h]=this._allocateImage(t[0],t[1]);else{a=new Ve.Z(0,0,t[0],t[1]),o=this._mosaicPages.length;const e=void 0;this._mosaicPages.push({mosaicsData:i,size:t,dirty:!0,texture:e})}if(a.width<=0||a.height<=0)return null;const l={rect:a,width:t[0],height:t[1],sdf:r,simplePattern:n,pixelRatio:1,page:o};return this._mosaicRects.set(e,l),Je(i)&&this._copy({rect:a,spriteSize:t,spriteData:i.data,page:o,pageSize:h,repeat:s,sdf:r}),l}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getSpriteItems(e){const t={};for(const i of e)t[i]=this.getSpriteItem(i);return t}getMosaicItemPosition(e){const t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;const s=t.width,r=t.height,n=p.fL,a=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+n)/a[0],(i.y+n)/a[1]],br:[(i.x+n+s)/a[0],(i.y+n+r)/a[1]],page:t.page}}bind(e,t,i=0,s=0){const r=this._mosaicPages[i],n=r.mosaicsData;let a=r.texture;if(a||(a=function(e,t,i){return Je(t)?new Ue.Z(e,{pixelFormat:6408,dataType:5121,width:i[0],height:i[1]},new Uint8Array(t.data.buffer)):new Ue.Z(e,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:i[0],height:i[1]},null)}(e,n,r.size),r.texture=a),a.setSamplingMode(t),Je(n))e.bindTexture(a,s),r.dirty&&(a.setData(new Uint8Array(n.data.buffer)),a.generateMipmap());else{const t=n.data,i=t.bindFrame(e,a,s);(0,m.pC)(this._requestRender)&&i&&t.frameCount>0&&this._requestRender.requestRender(),t.bindFrame(e,a,s)}r.dirty=!1}static _copyBits(e,t,i,s,r,n,a,o,h,l,d){let u=s*t+i,c=o*n+a;if(d){c-=n;for(let a=-1;a<=l;a++,u=((a+l)%l+s)*t+i,c+=n)for(let t=-1;t<=h;t++)r[c+t]=e[u+(t+h)%h]}else for(let i=0;i<l;i++){for(let t=0;t<h;t++)r[c+t]=e[u+t];u+=t,c+=n}}_copy(e){if(e.page>=this._mosaicPages.length)return;const t=this._mosaicPages[e.page],i=t.mosaicsData;if(!Je(t.mosaicsData))throw new h.Z("mapview-invalid-resource","unsuitable data type!");const s=e.spriteData,r=i.data;r&&s||console.error("Source or target images are uninitialized!"),et._copyBits(s,e.spriteSize[0],0,0,r,e.pageSize[0],e.rect.x+p.fL,e.rect.y+p.fL,e.spriteSize[0],e.spriteSize[1],e.repeat),t.dirty=!0}_allocateImage(e,t){e+=2*p.fL,t+=2*p.fL;const i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){const i=2**Math.ceil((0,Qe.k3)(e)),s=2**Math.ceil((0,Qe.k3)(t)),r=new Ve.Z(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(i*s)},size:[i,s],dirty:!0,texture:void 0}),[r,this._mosaicPages.length-1,[i,s]]}const s=this._binPack.allocate(e,t);if(s.width<=0){const i=this._mosaicPages[this._currentPage];return!i.dirty&&Je(i.mosaicsData)&&(i.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new Ze(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const e of this._mosaicPages){const t=e.texture;t&&t.dispose();const i=e.mosaicsData;Je(i)||i.data.pause()}this._mosaicPages=null,this._mosaicRects.clear()}}const tt=et,it=new Uint32Array(256);for(let e=0;e<256;e++){let t=e;for(let e=0;e<8;e++)t=0!=(1&t)?3988292384^t>>>1:t>>>1;it[e]=t}const st=new h.Z("Not a PNG"),rt=new h.Z("Not an animated PNG"),nt=new Uint8Array([137,80,78,71,13,10,26,10]);function at(e){const t=e.constructor===Uint8Array?e:new Uint8Array(e);return!nt.some(((e,i)=>e!==t[i]))}class ot{constructor(){this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}static async create(e,t){const i=new ot;try{await i._load(e,t)}catch(e){if(!(0,Be.D_)(e))return new h.Z("invalid-resource",`Could not load PNG: ${e.message}`)}return i}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(e,t,i){e.bindTexture(t,i);const s=this.frameChanged();if(!s)return!1;const r=this.currentFrame,n=r.frameData,a=t.descriptor;return(r.left||r.top||r.width!==a.width||r.height!==a.height)&&t.setData(null),t.updateData(0,r.left,r.top,r.width,r.height,n),this.updateUsedFrame(),s}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}async _load(e,t){try{const t=function(e,t){const i=new Uint8Array(t);if(nt.some(((e,t)=>e!==i[t])))return st;let s=!1;if(lt(i,(e=>!(s="acTL"===e))),!s)return rt;const r=[],n=[];let a=null,o=null,h=0;if(lt(i,((t,i,s,l)=>{const d=new DataView(i.buffer);switch(t){case"IHDR":a=i.subarray(s+8,s+8+l),e.width=d.getUint32(s+8),e.height=d.getUint32(s+12);break;case"acTL":e.numPlays=d.getUint32(s+8+4);break;case"fcTL":{o&&(e.frames.push(o),h++),o=new ht,o.width=d.getUint32(s+8+4),o.height=d.getUint32(s+8+8),o.left=d.getUint32(s+8+12),o.top=d.getUint32(s+8+16);const t=d.getUint16(s+8+20);let i=d.getUint16(s+8+22);0===i&&(i=100),o.delay=1e3*t/i,o.delay<=10&&(o.delay=100),e.playTime+=o.delay,o.disposeOp=d.getUint8(s+8+24),o.blendOp=d.getUint8(s+8+25),o.dataParts=[],0===h&&2===o.disposeOp&&(o.disposeOp=1);break}case"fdAT":o&&o.dataParts.push(i.subarray(s+8+4,s+8+l));break;case"IDAT":o&&o.dataParts.push(i.subarray(s+8,s+8+l));break;case"IEND":n.push(ut(i,s,12+l));break;default:r.push(ut(i,s,12+l))}})),0===e.frames.length)return rt;e.frameCount=e.frames.length;const l=new Blob(r),d=new Blob(n);return e.frames.forEach((e=>{let t=[];t.push(nt),a.set(mt(e.width),0),a.set(mt(e.height),4),t.push(ct("IHDR",a)),t.push(l),e.dataParts.forEach((e=>t.push(ct("IDAT",e)))),t.push(d),e.data=new Blob(t,{type:"image/png"}),delete e.dataParts,t=null})),e}(this,e);if(t!==this)return t;this._resizeCanvas=document.createElement("canvas"),this._resizeCanvas.width=this.width,this._resizeCanvas.height=this.height,await Promise.all(this.frames.map((e=>e.createImage(this._resizeCanvas))))}catch(e){if(!(0,Be.D_)(e))return new h.Z("invalid-resource","Could not parse PNG")}this.play()}_play(){let e,t;if(0===this.playSpeed)return void this.pause();this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,t-=1,t<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);const i=this.frames[this.currentFrameNumber];this.currentFrame={frameData:i.imageData,top:i.top,left:i.left,width:i.width,height:i.height},this.timerID=window.setTimeout((()=>this._play()),e)}}class ht{constructor(){this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}async createImage(e){if(null===this.imageData)return new Promise(((t,i)=>{const s=URL.createObjectURL(this.data),r=document.createElement("img");r.onload=()=>{URL.revokeObjectURL(s),this.imageData=function(e,t){t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);const s=i.getImageData(0,0,e.width,e.height),r=new Uint8Array(s.data);let n;for(let e=0;e<r.length;e+=4)n=r[e+3]/255,r[e]=r[e]*n,r[e+1]=r[e+1]*n,r[e+2]=r[e+2]*n;return new ImageData(new Uint8ClampedArray(r.buffer),e.width,e.height)}(r,e),t()},r.onerror=()=>{URL.revokeObjectURL(s),this.imageData=null,i(new Error("Image creation error"))},r.src=s}))}}function lt(e,t){const i=new DataView(e.buffer);let s,r,n,a=8;do{r=i.getUint32(a),s=dt(e,a+4,4),n=t(s,e,a,r),a+=12+r}while(!1!==n&&"IEND"!==s&&a<e.length)}function dt(e,t,i){const s=Array.prototype.slice.call(e.subarray(t,t+i));return String.fromCharCode.apply(String,s)}function ut(e,t,i){const s=new Uint8Array(i);return s.set(e.subarray(t,t+i)),s}function ct(e,t){const i=e.length+t.length,s=new Uint8Array(i+8),r=new DataView(s.buffer);r.setUint32(0,t.length),s.set(function(e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}(e),4),s.set(t,8);const n=function(e,t=0,i=e.length-t){let s=-1;for(let r=t,n=t+i;r<n;r++)s=s>>>8^it[255&(s^e[r])];return-1^s}(s,4,i);return r.setUint32(i+4,n),s}function mt(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}const pt=ot;function _t(e){if(!e||0===e.byteLength)return!1;const t=e.constructor===Uint8Array?e:new Uint8Array(e);return 71===t[0]&&73===t[1]&&70===t[2]&&56===t[3]}class ft{constructor(){this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}static async create(e,t){const i=new ft;try{await i._load(e,t)}catch(e){if(!(0,Be.D_)(e))return new h.Z("invalid-resource",`Could not load PNG: ${e.message}`)}return i}play(){this.playing||(this.paused=!1,this.playing=!0,this._play())}pause(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}togglePlay(){this.paused||!this.playing?this.play():this.pause()}bindFrame(e,t,i){e.bindTexture(t,i);const s=this.frameChanged();if(s){const e=this.currentFrame,i=e.frameData;t.updateData(0,0,0,e.width,e.height,i),this.updateUsedFrame()}return s}seekFrame(e){clearTimeout(this.timerID),this.currentFrameNumber=e%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}seek(e){clearTimeout(this.timerID),e<0&&(e=0),e*=1e3,e%=this.length;let t=0;for(;e>this.frames[t].time+this.frames[t].delay&&t<this.frames.length;)t+=1;this.currentFrameNumber=t,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}frameChanged(){return this._lastUsedFrame!==this.currentFrameNumber}updateUsedFrame(){this._lastUsedFrame=this.currentFrameNumber}async _load(e,t){try{this.loading=!0,await this._parse(e,t),this.loading=!1,this.play()}catch(e){if(!(0,Be.D_)(e))return new h.Z("invalid-resource","Could not parse gif!")}}_parse(e,t){const i=new gt(e);i.pos+=6,this.width=i.data[i.pos++]+(i.data[i.pos++]<<8),this.height=i.data[i.pos++]+(i.data[i.pos++]<<8);const s=i.data[i.pos++];return this.globalColourCount=1<<1+(7&s),i.pos++,i.pos++,128&s&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,i)),new Promise(((e,s)=>{setTimeout((()=>this._parseBlock(i,e,s,t)),0)}))}async _parseBlock(e,t,i,s){if(s&&s.signal&&(0,Be.Hc)(s.signal))return void i((0,Be.zE)());const r=e.data[e.pos++];if(44===r){if(this._parseImg(e),this.firstFrameOnly)return this._finishedLoading(),void t()}else{if(59===r)return this._finishedLoading(),void t();this._parseExt(e)}"function"==typeof this.onprogress&&this.onprogress({bytesRead:e.pos,totalBytes:e.data.length,frame:this.frames.length}),setTimeout((()=>this._parseBlock(e,t,i,s)),0)}_parseColourTable(e,t){const i=[];for(let s=0;s<e;s++)i.push([t.data[t.pos++],t.data[t.pos++],t.data[t.pos++]]);return i}_parseImg(e){const t={};this.frames.push(t),t.disposalMethod=this.disposalMethod,t.time=this.length,t.delay=10*this.delayTime,this.length+=t.delay,this.transparencyGiven?t.transparencyIndex=this.transparencyIndex:t.transparencyIndex=void 0,t.leftPos=e.data[e.pos++]+(e.data[e.pos++]<<8),t.topPos=e.data[e.pos++]+(e.data[e.pos++]<<8),t.width=e.data[e.pos++]+(e.data[e.pos++]<<8),t.height=e.data[e.pos++]+(e.data[e.pos++]<<8);const i=e.data[e.pos++];t.localColourTableFlag=!!(128&i),t.localColourTableFlag&&(t.localColourTable=this._parseColourTable(1<<1+(7&i),e)),this.pixelBufSize!==t.width*t.height&&(this.pixelBuf=new Uint8Array(t.width*t.height),this.pixelBufSize=t.width*t.height),this._lzwDecode(e.data[e.pos++],e.readSubBlocksB()),64&i?(t.interlaced=!0,(e=>{const t=this.pixelBufSize/e;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);let i=0;for(let s=0;s<4;s++)for(let r=this.interlaceOffsets[s];r<t;r+=this.interlaceSteps[s])this.deinterlaceBuf.set(this.pixelBuf.subarray(i,i+e),r*e),i+=e})(t.width)):t.interlaced=!1,this._processFrame(t)}_lzwDecode(e,t){let i,s,r,n,a,o,h,l,d;r=s=0;let u=[];const c=1<<e,m=c+1;for(n=e+1,d=!1;!d;){for(o=a,a=0,i=0;i<n;i++)t[r>>3]&1<<(7&r)&&(a|=1<<i),r++;if(a===c){for(u=[],n=e+1,i=0;i<c;i++)u[i]=[i];u[c]=[],u[m]=null}else{if(a===m)return void(d=!0);for(a>=u.length?u.push(u[o].concat(u[o][0])):o!==c&&u.push(u[o].concat(u[a][0])),h=u[a],l=h.length,i=0;i<l;i++)this.pixelBuf[s++]=h[i];u.length===1<<n&&n<12&&n++}}}_processFrame(e){e.image=document.createElement("canvas"),e.image.width=this.width,e.image.height=this.height,e.ctx=e.image.getContext("2d");const t=e.localColourTableFlag?e.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=e);const i=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod;i||e.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);const s=e.ctx.getImageData(e.leftPos,e.topPos,e.width,e.height),r=e.transparencyIndex,n=s.data,a=e.interlaced?this.deinterlaceBuf:this.pixelBuf,o=a.length;let h,l,d=0;for(let e=0;e<o;e++)h=a[e],l=t[h],r!==h?(n[d++]=l[0],n[d++]=l[1],n[d++]=l[2],n[d++]=255):i?(n[d+3]=0,d+=4):d+=4;e.ctx.putImageData(s,e.leftPos,e.topPos),this.lastFrame=e}_parseExt(e){const t=e.data[e.pos++];249===t?this._parseGCExt(e):254===t?this.comment+=e.readSubBlocks():255===t?this._parseAppExt(e):(1===t&&(e.pos+=13),e.readSubBlocks())}_parseAppExt(e){e.pos+=1,"NETSCAPE"===e.getString(8)?e.pos+=8:(e.pos+=3,e.readSubBlocks())}_parseGCExt(e){e.pos++;const t=e.data[e.pos++];this.disposalMethod=(28&t)>>2,this.transparencyGiven=!!(1&t),this.delayTime=e.data[e.pos++]+(e.data[e.pos++]<<8),this.transparencyIndex=e.data[e.pos++],e.pos++}_finishedLoading(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()}_play(){let e,t;0!==this.playSpeed?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,t-=1,t<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout((()=>this._play()),e)):this.pause()}_setCurrentFrame(e){const t=this.frames[e];this.currentFrame={frameData:t.image,top:0,left:0,width:this.width,height:this.height}}}class gt{constructor(e){this.pos=0,this.data=new Uint8ClampedArray(e),this.len=this.data.length}getString(e){let t="";for(;e--;)t+=String.fromCharCode(this.data[this.pos++]);return t}readSubBlocks(){let e,t,i="";do{for(t=e=this.data[this.pos++];t--;)i+=String.fromCharCode(this.data[this.pos++])}while(0!==e&&this.pos<this.len);return i}readSubBlocksB(){let e,t;const i=[];do{for(t=e=this.data[this.pos++];t--;)i.push(this.data[this.pos++])}while(0!==e&&this.pos<this.len);return i}}const vt=ft;var yt=i(32307);const wt=(0,Ee.c)(),bt="arial-unicode-ms-regular",xt=n.Z.getLogger("esri.views.2d.engine.webgl.TextureManager"),Ct=e=>"esriSMS"===e.type&&e.path;function Mt(e){switch(e.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":case"CIMVectorMarker":case"CIMPictureMarker":case"CIMCharacterMarker":return!1;default:return!0}}function Tt(e,t){const i=Math.round((0,g.F2)(t)*window.devicePixelRatio),s=i>=128?2:4;return Math.min(e,i*s)}const St=(e,t,i)=>xt.error(new h.Z(e,t,i));class Ft{constructor(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}static fromMosaic(e,t){return new Ft(e,t.page,t.sdf)}}var Pt=i(23244);class Rt{constructor(){this.name=this.constructor.name}}class zt extends Rt{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:{a_position:0}}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,t){if(!t.size)return;const{context:i,renderingOptions:s}=e;this._quad||(this._quad=new Pt.Z(i,[0,0,1,0,0,1,1,1]));const r=i.getBoundFramebufferObject(),{x:n,y:a,width:o,height:h}=i.getViewport();t.bindTextures(i);const l=t.getBlock(p.xl);if((0,m.Wi)(l))return;const d=l.getFBO(i),u=l.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,u,s.labelsAnimationTime),this._updateAnimationState(e,u,d),i.bindFramebuffer(r),i.setViewport(n,a,o,h)}_computeDelta(e,t,i){const{context:s,painter:r,displayLevel:n}=e,a=r.materialManager.getProgram(e,this._desc,["delta"]);s.bindFramebuffer(t),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),s.bindProgram(a),a.setUniform1i("u_maskTexture",p.iJ),a.setUniform1i("u_sourceTexture",p.nM),a.setUniform1f("u_timeDelta",e.deltaTime),a.setUniform1f("u_animationTime",i),a.setUniform1f("u_zoomLevel",Math.round(10*n)),this._quad.draw()}_updateAnimationState(e,t,i){const{context:s,painter:r}=e,n=r.materialManager.getProgram(e,this._desc,["update"]);s.bindTexture(t.colorTexture,1),s.bindProgram(n),n.setUniform1i("u_sourceTexture",1),s.bindFramebuffer(i),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const It=e=>`#define ${(e=>e.replace("-","_").toUpperCase())(e)}\n`,Dt={attributes:{a_pos:0,a_tex:1},shaders:e=>({vertexShader:It(e)+(0,Me.w)("blend/blend.vert"),fragmentShader:It(e)+(0,Me.w)("blend/blend.frag")})},Bt=n.Z.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class Ot{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null),this._programCache&&(this._programCache.dispose(),this._programCache=null),this._quad&&(this._quad.dispose(),this._quad=null)}draw(e,t,i,s,r){const{context:n,drawPhase:a}=e;if(this._setupShader(n),s&&"normal"!==s&&a!==te.jx.LABEL)return void this._drawBlended(e,t,i,s,r);const o=this._programCache.getProgram(Dt,"normal");if(!o)return void Bt.error(new h.Z("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));n.bindProgram(o),t.setSamplingMode(i),n.bindTexture(t,0),o.setUniform1i("u_layerTexture",0),o.setUniform1f("u_opacity",r),n.setBlendingEnabled(!0),n.setBlendFunction(1,771);const l=this._quad;l.draw(),l.unbind()}_drawBlended(e,t,i,s,r){const{context:n,state:a,pixelRatio:o,inFadeTransition:l}=e,{size:d}=a,u=n.getBoundFramebufferObject();let c,p;if((0,m.pC)(u)){const e=u.descriptor;c=e.width,p=e.height}else c=Math.round(o*d[0]),p=Math.round(o*d[1]);this._createOrResizeTexture(e,c,p);const _=this._backBufferTexture;u.copyToTexture(0,0,c,p,0,0,_),n.setStencilTestEnabled(!1),n.setStencilWriteMask(0),n.setBlendingEnabled(!0),n.setDepthTestEnabled(!1),n.setDepthWriteEnabled(!1);const f=this._programCache.getProgram(Dt,s);if(!f)return void Bt.error(new h.Z("mapview-BlendEffect",`Error creating shader program for blend mode ${s}`));n.bindProgram(f),_.setSamplingMode(i),n.bindTexture(_,0),f.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),n.bindTexture(t,1),f.setUniform1i("u_layerTexture",1),f.setUniform1f("u_opacity",r),f.setUniform1f("u_inFadeOpacity",l?1:0),n.setBlendFunction(1,0);const g=this._quad;g.draw(),g.unbind(),n.setBlendFunction(1,771)}_setupShader(e){this._programCache||(this._programCache=new Fe.Z(e),this._quad||(this._quad=new Pt.Z(e,[-1,-1,1,-1,-1,1,1,1])))}_createOrResizeTexture(e,t,i){const{context:s}=e;null!==this._backBufferTexture&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new Ue.Z(s,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}class Et extends Rt{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:t}){this._prev=e.getBoundFramebufferObject();const{width:i,height:s}=e.getViewport(),r=t.getFbos(i,s).effect0;e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,t){const{context:i,painter:s,state:r,deltaTime:n}=e,a=s.getPostProcessingEffects(t.effects),o=i.getBoundFramebufferObject();a.length&&t.transitionStep(n,r.scale);for(const{postProcessingEffect:t,effect:i}of a)t.draw(e,o,i);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),s.blitTexture(i,o.colorTexture,9728),i.setStencilTestEnabled(!0)}}const At=[void 0,void 0,void 0,1],kt=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],Lt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Ut=n.Z.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient"),Vt=[0,0,0,0],Zt={shaders:{vertexShader:(0,Me.w)("highlight/textured.vert"),fragmentShader:(0,Me.w)("highlight/highlight.frag")},attributes:{a_position:0,a_texcoord:1}},Ht={shaders:{vertexShader:(0,Me.w)("highlight/textured.vert"),fragmentShader:(0,Me.w)("highlight/blur.frag")},attributes:{a_position:0,a_texcoord:1}};function Nt(e,t,i){const s=new Ue.Z(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:t,height:i,samplingMode:9729});return[s,new Q.Z(e,{colorTarget:0,depthStencilTarget:2},s)]}const Wt=3/4,qt=class extends Rt{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new class{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,t){e.bindTexture(t,p.QU),e.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",kt),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}finalBlur(e,t){e.bindTexture(t,p.QU),e.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Lt),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}renderHighlight(e,t,i){e.bindTexture(t,p.QU),e.bindProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(1,771),e.drawArrays(5,0,4),e.bindVAO()}_initialize(e,t,i){this._width=t,this._height=i;const s=Y.Z.createVertex(e,35044,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),r=new X.Z(e,{a_position:0,a_texcoord:1},{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!1},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!1}]},{geometry:s}),n=(0,J.H)(e,Zt),a=(0,J.H)(e,Ht);n.setUniform1i("u_texture",p.QU),n.setUniform1i("u_shade",p.Jw),n.setUniform4fv("u_sigmas",At),a.setUniform1i("u_texture",p.QU),a.setUniform4fv("u_sigmas",At),this._resources={quadGeometry:s,quadVAO:r,highlightProgram:n,blurProgram:a}}setup(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}},this._hlGradient=new class{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:0,outlineWidth:.7,innerHaloWidth:.7,outerHaloWidth:.7},this.shadeTexChanged=!0,this.texelData=new Uint8Array(1024),this.minMaxDistance=[0,0]}setHighlightOptions(e){const t=this._convertedHighlightOptions;!function(e,t){t.fillColor[0]=e.color.r/255,t.fillColor[1]=e.color.g/255,t.fillColor[2]=e.color.b/255,t.fillColor[3]=e.color.a,e.haloColor?(t.outlineColor[0]=e.haloColor.r/255,t.outlineColor[1]=e.haloColor.g/255,t.outlineColor[2]=e.haloColor.b/255,t.outlineColor[3]=e.haloColor.a):(t.outlineColor[0]=t.fillColor[0],t.outlineColor[1]=t.fillColor[1],t.outlineColor[2]=t.fillColor[2],t.outlineColor[3]=t.fillColor[3]),t.fillColor[3]*=e.fillOpacity,t.outlineColor[3]*=e.haloOpacity,t.fillColor[0]*=t.fillColor[3],t.fillColor[1]*=t.fillColor[3],t.fillColor[2]*=t.fillColor[3],t.outlineColor[0]*=t.outlineColor[3],t.outlineColor[1]*=t.outlineColor[3],t.outlineColor[2]*=t.outlineColor[3],t.outlineWidth=.7,t.outerHaloWidth=.7,t.innerHaloWidth=.7,t.outlinePosition=0}(e,t);const i=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,s=t.outlinePosition-t.outlineWidth/2,r=t.outlinePosition+t.outlineWidth/2,n=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,a=Math.sqrt(Math.PI/2)*At[3],o=Math.abs(i)>a?Math.round(10*(Math.abs(i)-a))/10:0,h=Math.abs(n)>a?Math.round(10*(Math.abs(n)-a))/10:0;let l;o&&!h?Ut.error("The outer rim of the highlight is "+o+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!o&&h?Ut.error("The inner rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):o&&h&&Ut.error("The highlight is "+Math.max(o,h)+"px away from the edge of the feature; consider reducing some width values.");const d=[void 0,void 0,void 0,void 0];function u(e,t,i){d[0]=(1-i)*e[0]+i*t[0],d[1]=(1-i)*e[1]+i*t[1],d[2]=(1-i)*e[2]+i*t[2],d[3]=(1-i)*e[3]+i*t[3]}const{texelData:c}=this;for(let e=0;e<256;++e)l=i+e/255*(n-i),l<i?(d[4*e+0]=0,d[4*e+1]=0,d[4*e+2]=0,d[4*e+3]=0):l<s?u(Vt,t.outlineColor,(l-i)/(s-i)):l<r?[d[0],d[1],d[2],d[3]]=t.outlineColor:l<n?u(t.outlineColor,t.fillColor,(l-r)/(n-r)):[d[4*e+0],d[4*e+1],d[4*e+2],d[4*e+3]]=t.fillColor,c[4*e+0]=255*d[0],c[4*e+1]=255*d[1],c[4*e+2]=255*d[2],c[4*e+3]=255*d[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=n,this.shadeTexChanged=!0}applyHighlightOptions(e,t){this.shadeTex||(this.shadeTex=new Ue.Z(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:256,height:1,samplingMode:9729})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,256,1,this.texelData),this.shadeTexChanged=!1),e.bindTexture(this.shadeTex,p.Jw),t.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}},this._width=void 0,this._height=void 0,this._hlSurfaces=new class{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,t,i){this._width=t,this._height=i;const[s,r]=Nt(e,t,i),[n,a]=Nt(e,t,i);this._resources={sharedBlur1Tex:s,sharedBlur1Fbo:r,sharedBlur2Tex:n,sharedBlur2Fbo:a}}setup(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}},this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new Se}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(e){const{context:t,painter:i}=e,{width:s,height:r}=t.getViewport(),n=i.getFbos(s,r).effect0;this.setup(e,s,r),t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},t,i){this._width=t,this._height=i;const s=t%4,r=i%4;t+=s<2?-s:4-s,i+=r<2?-r:4-r,this._adjustedWidth=t,this._adjustedHeight=i,this._boundFBO=e.getBoundFramebufferObject();const n=Math.round(t*Wt),a=Math.round(i*Wt);this._hlRenderer.setup(e,n,a),this._hlSurfaces.setup(e,n,a)}draw({context:e}){const t=e.getBoundFramebufferObject();e.setViewport(0,0,this._adjustedWidth*Wt,this._adjustedHeight*Wt),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setStencilTestEnabled(!1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(e,t.colorTexture,9728,1),e.setStencilTestEnabled(!1),e.setBlendingEnabled(!1),e.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(e,this._hlSurfaces.sharedBlur1Tex),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(e,this._hlSurfaces.sharedBlur2Tex),e.bindFramebuffer(this._boundFBO),e.setBlendingEnabled(!0),e.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(e,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(e){this._hlGradient.setHighlightOptions(e)}};class Gt extends Rt{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){(0,m.pC)(this._fbo)&&this._fbo.dispose()}bind({context:e,painter:t}){const{width:i,height:s}=e.getViewport(),r=t.getFbos(i,s).effect0;e.bindFramebuffer(r),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw({context:e,state:t,pixelRatio:i},s,r=p.Jc){const n=e.getBoundFramebufferObject(),a=t.size[1]*i,o=Math.round(r*i),h=o/2,l=o/2;this._ensureBuffer(o),s.forEach(((e,t)=>{const r=new Map,d=Math.floor(t[0]*i-o/2),u=Math.floor(a-t[1]*i-o/2);n.readPixels(d,u,o,o,6408,5121,this._buf);for(let e=0;e<this._buf32.length;e++){const t=this._buf32[e];if(4294967295!==t&&0!==t){const i=e%o,s=o-Math.floor(e/o),n=(h-i)*(h-i)+(l-s)*(l-s),a=r.has(t)?r.get(t):4294967295;r.set(t,Math.min(n,a))}}const c=Array.from(r).sort(((e,t)=>e[1]-t[1])).map((e=>e[0]));e.resolve(c),s.delete(t)}))}_ensureBuffer(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}function $t(e){switch(e){case"bloom":case"blur":case"opacity":case"drop-shadow":return e;default:return"colorize"}}const jt={colorize:async()=>new((await i.e(260).then(i.bind(i,80260))).Colorize),blur:async()=>new((await i.e(1376).then(i.bind(i,41376))).Blur),bloom:async()=>new((await i.e(5730).then(i.bind(i,25730))).Bloom),opacity:async()=>new((await i.e(1342).then(i.bind(i,51342))).Opacity),"drop-shadow":async()=>new((await i.e(339).then(i.bind(i,60339))).DropShadow)};class Kt{constructor(e){this._requestRender=e,this._effectMap=new Map,this._effectPromiseMap=new Map}dispose(){this._requestRender&&(this._requestRender=null),this._effectMap.forEach((e=>e.dispose())),this._effectMap.clear(),this._effectPromiseMap.clear()}getPostProcessingEffects(e){if(!e||0===e.length)return[];const t=[];for(const i of e){const e=$t(i.type),s=this._effectMap.get(e);s?t.push({postProcessingEffect:s,effect:i}):this._enablePostProcessingEffect(e)}return t}async _enablePostProcessingEffect(e){const t=await this._loadPostProcessingEffect(e);this._requestRender&&(this._effectMap.set(e,t),this._requestRender.requestRender())}async _loadPostProcessingEffect(e){return this._effectPromiseMap.has(e)||this._effectPromiseMap.set(e,jt[e]()),this._effectPromiseMap.get(e)}}var Yt=i(19677);function Xt(e,t,i){return 1!==i||(0,m.pC)(e)&&"normal"!==e||(0,m.pC)(t)&&t.length>0}const Qt=class{constructor(e,t){this.context=e,this._blitRenderer=new Se,this._brushCache=new Map,this._vtlMaterialManager=new class{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach((e=>e.dispose())),this._programByKey.clear()}getMaterialProgram(e,t,i){const s=t.key<<2|this._getMaterialOptionsValue(t.type,i);if(this._programByKey.has(s))return this._programByKey.get(s);const r=this._getProgramTemplate(t.type),{shaders:n}=r,{vertexShader:a,fragmentShader:o}=n(i),h=t.getShaderHeader(),l=t.getShaderMain(),d=a.replace("#pragma header",h).replace("#pragma main",l),u=new ne.Z(e,d,o,t.getAttributeLocations());return this._programByKey.set(s,u),u}_getMaterialOptionsValue(e,t){switch(e){case 0:{const e=t;return(e.pattern?1:0)<<1|(e.id?1:0)}case 1:{const e=t;return(e.pattern?1:0)<<1|(e.id?1:0)}case 2:return t.id?1:0;case 3:{const e=t;return(e.pattern?1:0)<<1|(e.id?1:0)}case 4:{const e=t;return(e.sdf?1:0)<<1|(e.id?1:0)}case 5:case 6:return t.id?1:0;default:return 0}}_getProgramTemplate(e){switch(e){case 0:return ue;case 5:return me;case 1:return _e;case 4:return ye;case 3:return be;case 2:return ge;case 6:return Ce;default:return null}}},this._blendEffect=new Ot,this.effects={highlight:new qt,hittest:new Gt,integrate:new zt,insideEffect:new Et("inside"),outsideEffect:new Et("outside")},this.materialManager=new class{constructor(e){this._programByKey=new Map,this._programCache=new Fe.Z(e)}dispose(){this._programCache&&this._programCache.dispose()}getProgram(e,t,i=[],s=[]){const r=t.vsPath+"."+t.fsPath+JSON.stringify(i)+s.join(".");if(this._programByKey.has(r))return this._programByKey.get(r);const n=s.reduce(((t,i)=>({...t,[i]:e.driverTestResult[i]})),{}),a={...i.map((e=>"string"==typeof e?{name:e,value:!0}:e)).reduce(((e,t)=>({...e,[t.name]:t.value})),{}),...n},{vsPath:o,fsPath:h,attributes:l}=t,d=this._programCache.getProgram(ze(o,h,l),a);if(!d)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(r,d),d}getMaterialProgram(e,t,i,s,r,n=["ignoresSamplerPrecision"]){const a=(({rendererInfo:e,drawPhase:t},i,s,r)=>`${i.getVariationHash()}-${r.join(".")}-${(e=>(Ie(e)?1:0)|(e===te.jx.HIGHLIGHT?2:0))(t)}-${e.getVariationHash()}-${(0,m.pC)(s)&&s.join(".")}`)(e,t,r,n);if(this._programByKey.has(a))return this._programByKey.get(a);const o=((e,t,i,s)=>{const r=s.reduce(((t,i)=>({...t,[i]:e.driverTestResult[i]})),{}),n={...t.getVariation(),...e.rendererInfo.getVariation(),highlight:e.drawPhase===te.jx.HIGHLIGHT,id:Ie(e.drawPhase),...r};if((0,m.pC)(i))for(const e of i)n[e]=!0;return n})(e,t,r,n),h=this._programCache.getProgram(ze(i,i,s),o);if(!h)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(a,h),h}}(e),this.textureManager=new class{constructor(e){this._invalidFontsMap=new Map,this._sdfConverter=new class{constructor(e){this.size=e;const t=document.createElement("canvas");t.width=t.height=e,this._context=t.getContext("2d"),this._gridOuter=new Float64Array(e*e),this._gridInner=new Float64Array(e*e),this._f=new Float64Array(e),this._d=new Float64Array(e),this._z=new Float64Array(e+1),this._v=new Int16Array(e)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,t,i=31){this._initSVG();const s=this._createSVGString(e);return new Promise(((e,r)=>{const n=new Image;n.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(s),n.onload=()=>{n.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(n,0,0,this.size,this.size);const t=this._context.getImageData(0,0,this.size,this.size),s=new Uint8Array(this.size*this.size*4);for(let e=0;e<this.size*this.size;e++){const i=t.data[4*e+3]/255;this._gridOuter[e]=1===i?0:0===i?Xe:Math.max(0,.5-i)**2,this._gridInner[e]=1===i?Xe:0===i?0:Math.max(0,i-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let e=0;e<this.size*this.size;e++)Ke(.5-(this._gridOuter[e]-this._gridInner[e])/(2*i),s,4*e);e(s)};const a=t&&t.signal;a&&(0,Be.fu)(a,(()=>r((0,Be.zE)())))}))}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}}_createSVGString(e){const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",e),this._svg.appendChild(t);const i=t.getBBox(),s=i.width/i.height,r=this.size/2;let n,a,o,h;if(s>1){a=n=r/i.width;const e=r*(1/s);o=this.size/4,h=r-e/2}else n=a=r/i.height,o=r-r*s/2,h=this.size/4;const l=-i.x*n+o,d=-i.y*a+h;t.setAttribute("style",`transform: matrix(${n}, 0, 0, ${a}, ${l}, ${d})`);const u=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(t),u}_edt(e,t,i){const s=this._f,r=this._d,n=this._v,a=this._z;for(let o=0;o<t;o++){for(let r=0;r<i;r++)s[r]=e[r*t+o];this._edt1d(s,r,n,a,i);for(let s=0;s<i;s++)e[s*t+o]=r[s]}for(let o=0;o<i;o++){for(let i=0;i<t;i++)s[i]=e[o*t+i];this._edt1d(s,r,n,a,t);for(let i=0;i<t;i++)e[o*t+i]=Math.sqrt(r[i])}}_edt1d(e,t,i,s,r){i[0]=0,s[0]=-Xe,s[1]=+Xe;for(let t=1,n=0;t<r;t++){let r=(e[t]+t*t-(e[i[n]]+i[n]*i[n]))/(2*t-2*i[n]);for(;r<=s[n];)n--,r=(e[t]+t*t-(e[i[n]]+i[n]*i[n]))/(2*t-2*i[n]);n++,i[n]=t,s[n]=r,s[n+1]=+Xe}for(let n=0,a=0;n<r;n++){for(;s[a+1]<n;)a++;t[n]=(n-i[a])*(n-i[a])+e[i[a]]}}}(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._rasterizer=new Le.Z,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Ae.e({concurrency:10,process:async(e,t)=>{(0,Be.k_)(t);try{return await(0,Oe.default)(e,{responseType:"image",signal:t})}catch(t){if(!(0,Be.D_)(t))throw new h.Z("mapview-invalid-resource",`Could not fetch requested resource at ${e}`,t);throw t}}}),this._spriteMosaic=new tt(e,2048,2048,500),this._glyphSource=new class{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t,i){const s=this._getFontStack(e);if(s.getRange(t))return Promise.resolve();const r=256*t,n=r+255,a=this._baseURL.replace("{fontstack}",e).replace("{range}",r+"-"+n);return(0,Oe.default)(a,{responseType:"array-buffer",...i}).then((e=>{s.addRange(t,new We(new Ne.Z(new Uint8Array(e.data),new DataView(e.data))))}))}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const s=Math.floor(t/256);if(s>256)return;const r=i.getRange(s);return r?{metrics:r.getMetrics(t),bitmap:r.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new qe),t}}(`${De.Z.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new class{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new Ze(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const e=[117,149,181,207,207,181,149,117],t=[];for(let i=0;i<e.length;i++){const s=e[i];for(let e=0;e<11;e++)t.push(s)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(i)}async getGlyphItems(e,t,i){const s=this._getGlyphCache(e);return await this._fetchRanges(e,t,i),t.map((t=>this._getMosaicItem(s,e,t)))}bind(e,t,i,s){const r=this._getTexture(e,i);r.setSamplingMode(t),this._dirties[i]&&(r.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(r,s)}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_getTexture(e,t){return this._textures[t]||(this._textures[t]=new Ue.Z(e,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(e,t,i){const s=function(e){const t=new Set;for(const i of e)t.add(He(i));return t}(t),r=[];s.forEach((t=>{r.push(this._fetchRange(e,t,i))})),await Promise.all(r)}async _fetchRange(e,t,i){if(t>256)return null;const s=e+t;return function(e,t,i){return e.has(t)||e.set(t,i().then((()=>{e.delete(t)})).catch((i=>{e.delete(t),(0,Be.H9)(i)}))),e.get(t)}(this._rangePromises,s,(()=>this._glyphSource.getRange(e,t,i)))}_getMosaicItem(e,t,i){if(!e[i]){const s=this._glyphSource.getGlyph(t,i);if(!s||!s.metrics)return(e=>({rect:new Ve.Z(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:e,sdf:!0}))(i);const r=this._recordGlyph(s),n=this._currentPage,a=s.metrics;e[i]={rect:r,page:n,metrics:a,code:i,sdf:!0},this._invalidate()}return e[i]}_recordGlyph(e){const t=e.metrics;let i;if(0===t.width)i=new Ve.Z(0,0,0,0);else{const s=3,n=t.width+2*s,a=t.height+2*s;i=this._binPack.allocate(n,a),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new Ze(this.width-4,this.height-4),i=this._binPack.allocate(n,a));const o=this._glyphData[this._currentPage],h=e.bitmap;let l,d;if(h)for(let e=0;e<a;e++){l=n*e,d=this.width*(i.y+e)+i.x;for(let e=0;e<n;e++)o[d+e]=h[l+e]}(0,r.Z)("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(e){const t=document.createElement("canvas"),i=t.getContext("2d"),s=new ImageData(this.width,this.height),r=s.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(let t=0;t<e.length;++t)r[4*t+0]=e[t],r[4*t+1]=0,r[4*t+2]=0,r[4*t+3]=255;i.putImageData(s,0,0),document.body.appendChild(t)}}(1024,1024,this._glyphSource)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._rasterizer=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(e,t,i,s){if((0,m.Wi)(e))return St("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"CIMTextSymbol":case"esriTS":{const t=await this._rasterizeText(e,i,s);return t.forEach((e=>this._setTextureBinding(te.Un.GLYPH,e))),{glyphMosaicItems:t}}case"esriSMS":case"esriPMS":case"esriSFS":case"esriPFS":case"esriSLS":default:{if((e=>e.type&&-1!==e.type.toLowerCase().indexOf("3d"))(e))return St("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const i=await this._rasterizeSpriteSymbol(e,t,s);return(0,yt.ok)(i)&&i&&this._setTextureBinding(te.Un.SPRITE,i),{spriteMosaicItem:i}}}}bindTextures(e,t,i,s=!1){if(0===i.textureBinding)return;const r=this._bindingInfos[i.textureBinding-1],n=r.page,a=s?9987:9729;switch(r.mosaicType){case te.Un.SPRITE:{const i=this.sprites.getWidth(n),s=this.sprites.getHeight(n),r=(0,q.s)(wt,i,s);return this._spriteMosaic.bind(e,a,n,p.D3),t.setUniform1i("u_texture",p.D3),void t.setUniform2fv("u_mosaicSize",r)}case te.Un.GLYPH:{const i=this.glyphs.width,s=this.glyphs.height,r=(0,q.s)(wt,i,s);return this._glyphMosaic.bind(e,a,n,p.Al),t.setUniform1i("u_texture",p.Al),void t.setUniform2fv("u_mosaicSize",r)}default:xt.error("mapview-texture-manager",`Cannot handle unknown type ${r.mosaicType}`)}}_hashMosaic(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}_setTextureBinding(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const s=Ft.fromMosaic(e,t),r=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,r),this._bindingInfos.push(s)}t.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(e,t,i){const s=function(e){const t=function(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(e)+function(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblic":return"-italic"}return""}(e);return function(e){const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}(e.family)+(t.length>0?t:"-regular")}(e.font),r=this._invalidFontsMap.has(s),n=t||function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e.charCodeAt(i));return t}((0,ke.E)(e.text)[0]);try{return await this._glyphMosaic.getGlyphItems(r?bt:s,n,i)}catch(e){return St("mapview-invalid-resource",`Couldn't find font ${s}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(s,!0),this._glyphMosaic.getGlyphItems(bt,n,i)}}async _rasterizeSpriteSymbol(e,t,i){if(function(e){switch(e.type){case"CIMSolidStroke":case"CIMSolidFill":return!0;case"esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case"esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}(e))return null;const s=function(e){switch(e.type){case"esriSMS":return`${e.style}.${e.path}`;case"esriSLS":return`${e.style}.${e.cap}`;case"esriSFS":return`${e.style}`;case"esriPFS":case"esriPMS":return e.imageData?`${e.imageData}${e.width}${e.height}`:`${e.url}${e.width}${e.height}`;default:return e.mosaicHash?e.mosaicHash:JSON.stringify(e)}}(e);if(this._spriteMosaic.has(s))return this._spriteMosaic.getSpriteItem(s);if(Ct(e)||(e=>e.url||e.imageData)(e))return this._handleAsyncResource(s,e,i);const r=this._rasterizer.rasterizeJSONResource(e,t);if(r){const{size:t,image:i,sdf:n,simplePattern:a}=r;return this._addItemToMosaic(s,t,{type:"static",data:i},Mt(e),n,a)}return new h.Z("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(e,t,i){if(this._ongoingRasterizations.has(e))return this._ongoingRasterizations.get(e);let s;s=Ct(t)?this._handleSVG(t,e,i):this._handleImage(t,e,i),this._ongoingRasterizations.set(e,s);try{await s,this._ongoingRasterizations.delete(e)}catch{this._ongoingRasterizations.delete(e)}return s}async _handleSVG(e,t,i){const s=await this._sdfConverter.draw(e.path,i);return this._addItemToMosaic(t,[126,126],{type:"static",data:new Uint32Array(s.buffer)},!1,!0,!0)}async _handleGIFOrPNG(e,t,i){const s=await async function(e,t){const i=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;let s;const r=";base64,";if(-1!==i.indexOf(r)){const e=i.indexOf(r)+r.length,t=i.substring(e),n=atob(t),a=new Uint8Array(n.length);for(let e=0;e<n.length;e++)a[e]=n.charCodeAt(e);s=a.buffer}else try{const{data:e}=await(0,Oe.default)(i,{responseType:"array-buffer",...t});s=e}catch(e){if(!(0,Be.D_)(e))return new h.Z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`)}return s}(e,i);if((0,yt.ok)(s)){const r=_t(s),n=at(s);if(!r&&!n)return new h.Z("mapview-invalid-resource","Image data is neither GIF nor PNG!");let a;try{r&&function(e){if(!e||0===e.byteLength)return!1;const t=new Uint8Array(e);if(!_t(t))return!1;let i=0;for(let e=0,s=t.length-9;e<s&&(0!==t[e]||33!==t[e+1]||249!==t[e+2]||4!==t[e+3]||0!==t[e+8]||44!==t[e+9]&&33!==t[e+9]||(i++,!(i>1)));++e);return i>1}(s)?a=await vt.create(s,i):n&&function(e){const t=new Uint8Array(e);if(!at(t))return!1;let i=!1;return lt(t,(e=>!(i="acTL"===e))),i}(s)&&(a=await pt.create(s,i))}catch(e){if(!(0,Be.D_)(e))return new h.Z("mapview-invalid-resource","Could not fetch requested resource!")}if(a&&(0,yt.ok)(a))return this._addItemToMosaic(t,[a.width,a.height],{type:"animated",data:a},Mt(e),!1,!1);const o=new Blob([s],{type:r?"image/gif":"image/png"}),l=await this._imageFromBlob(o);if(l&&l instanceof HTMLImageElement){let i=l.width,s=l.height;"esriPMS"===e.type&&(i=Math.round(Tt(l.width,e.width)),s=Math.round(l.height*(i/l.width)));const{size:r,sdf:n,image:a}=this._rasterizer.rasterizeImageResource(i,s,l,e.colorSubstitutions);return this._addItemToMosaic(t,r,{type:"static",data:a},Mt(e),n,!1)}}return new h.Z("mapview-invalid-resource","Could not handle resource!")}async _handleImage(e,t,i){if((e=>e.url&&-1!==e.url.indexOf(".gif")||e.contentType&&"image/gif"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/gif"))(e)||(e=>e.url&&-1!==e.url.indexOf(".png")||e.contentType&&"image/png"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/png"))(e))return this._handleGIFOrPNG(e,t,i);const s=e.imageData?`data:${e.contentType};base64,${e.imageData}`:e.url;try{const{data:r}=await this._imageRequestQueue.push(s,{...i});(e=>-1!==e.indexOf("data:image/svg+xml"))(s)&&(r.width=(0,g.F2)(e.width),r.height=(0,g.F2)(e.height));let n=r.width,a=r.height;"esriPMS"===e.type&&(n=Math.round(Tt(r.width,e.width)),a=Math.round(r.height*(n/r.width)));const{size:o,sdf:h,image:l}=this._rasterizer.rasterizeImageResource(n,a,r,e.colorSubstitutions);return this._addItemToMosaic(t,o,{type:"static",data:l},Mt(e),h,!1)}catch(e){if(!(0,Be.D_)(e))return new h.Z("mapview-invalid-resource",`Could not fetch requested resource at ${s}. ${e.message}`)}}async _imageFromBlob(e){const t=window.URL.createObjectURL(e);try{const{data:e}=await this._imageRequestQueue.push(t);return window.URL.revokeObjectURL(t),e}catch(e){if(window.URL.revokeObjectURL(t),!(0,Be.D_)(e))return new h.Z("mapview-invalid-resource",`Could not fetch requested resource at ${t}`);throw e}}_addItemToMosaic(e,t,i,s,r,n){return this._spriteMosaic.addSpriteItem(e,t,i,s,r,n)}}(t),this._effectsManager=new Kt(t)}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(e){this._renderTarget=e}getFbos(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const i in this._fbos)this._fbos[i].resize(e,t);return this._fbos}const i={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:t},s={colorTarget:0,depthStencilTarget:3},r=new se.Z(this.context,{width:e,height:t,internalFormat:34041});this._stencilBuf=r,this._fbos={output:new Q.Z(this.context,s,i,r),blend:new Q.Z(this.context,s,i,r),effect0:new Q.Z(this.context,s,i,r)}}return this._fbos}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(e,t=null){const{width:i,height:s}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const r=this.getFbos(i,s);if(e.bindFramebuffer(r.output),e.setColorMask(!0,!0,!0,!0),e.setDepthWriteEnabled(!0),(0,m.pC)(t)){const{r:i,g:s,b:r,a:n}=t.color;e.setClearColor(n*i/255,n*s/255,n*r/255,n)}else e.setClearColor(0,0,0,0);e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}beforeRenderLayer(e,t,i){const{context:s,blendMode:r,effects:n,requireFBO:a}=e;if(a||Xt(r,n,i))s.bindFramebuffer(this._fbos.blend),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT);else{const e=this._getOutputFBO();s.bindFramebuffer(e)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(t),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)}compositeLayer(e,t){const{context:i,blendMode:s,effects:r,requireFBO:n}=e;if(n||Xt(s,r,t)){(0,m.pC)(r)&&r.length>0&&e.drawPhase===te.jx.MAP&&this._applyEffects(e,r);const n=this._getOutputFBO();i.bindFramebuffer(n),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(1,771,1,771),i.setColorMask(!0,!0,!0,!0);const a=(0,m.pC)(s)?s:"normal";this._blendEffect.draw(e,this._fbos.blend.colorTexture,9728,a,t)}}renderLayers(e){if(e.bindFramebuffer(this._prevFBO),!this._fbos)return;const t=this._getOutputFBO();e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),this.blitTexture(e,t.colorTexture,9728)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();if(this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null}getGeometryBrush(e){const t={[te.LW.FILL]:re.U.fill,[te.LW.LINE]:re.U.line,[te.LW.MARKER]:re.U.marker,[te.LW.TEXT]:re.U.text}[e];let i=this._brushCache.get(t);return void 0===i&&(i=new t,this._brushCache.set(t,i)),this._brushCache.get(t)}renderObject(e,t,i,s){const r=re.U[i];if(!r)return null;let n=this._brushCache.get(r);void 0===n&&(n=new r,this._brushCache.set(r,n)),n.prepareState(e,t,s),n.draw(e,t,s)}renderObjects(e,t,i,s){const r=re.U[i];if(!r)return null;let n=this._brushCache.get(r);void 0===n&&(n=new r,this._brushCache.set(r,n)),n.drawMany(e,t,s)}registerRenderPass(e){const t=e.brushes.map((e=>(this._brushCache.has(e)||this._brushCache.set(e,new e),this._brushCache.get(e))));return new class{constructor(e,t){var i;this.brushes=e,this.name=t.name,this.drawPhase=t.drawPhase||te.jx.MAP,this._targetFn=t.target,this.effects=t.effects||[],this.enableDefaultDraw=null!=(i=t.enableDefaultDraw)?i:()=>!0,this.has=t.has}render(e){const{context:t,profiler:i}=e,s=this._targetFn(),n=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),n&&(!this.has||(0,r.Z)(this.has))){this.enableDefaultDraw()&&this._doRender(e,s),i.recordPassEnd();for(const r of this.effects){if(!r.enable())continue;const n=r.apply;i.recordPassStart(this.name+"."+n.name),i.recordBrushStart(n.name);const a=r.args&&r.args(),{x:o,y:h,width:l,height:d}=t.getViewport(),u=t.getBoundFramebufferObject();n.bind(e,a),this._doRender(e,s,n.defines),n.draw(e,a),n.unbind(e,a),t.bindFramebuffer(u),t.setViewport(o,h,l,d),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(e,t,i){if(!(0,m.Wi)(t))if((0,Yt.zG)(t)){for(const s of t)if(s.visible)for(const t of this.brushes)e.profiler.recordBrushStart(t.name),t.prepareState(e,s,i),t.draw(e,s,i),e.profiler.recordBrushEnd()}else for(const s of this.brushes)e.profiler.recordBrushStart(s.name),s.prepareState(e,t,i),s.draw(e,t,i),e.profiler.recordBrushEnd()}}(t,e)}setHighlightOptions(e){this.effects.highlight.setHighlightOptions(e)}blitTexture(e,t,i,s=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,s)}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}_getOutputFBO(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}_applyEffects(e,t){const{context:i}=e,s=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:t,effect:r}of s)i.bindFramebuffer(this._fbos.blend),t.draw(e,this._fbos.blend,r)}};var Jt=i(35470),ei=i(4688),ti=i(86733);const ii=(0,r.Z)("esri-2d-profiler");class si{constructor(e,t){if(this._events=new Jt.Z,this._entries=new Map,this._timings=new ei.Z(10),!ii)return;this._ext=(0,ti.m)(e.gl,{}),this._debugOutput=t;const i=e.gl;if(this.enableCommandLogging)for(const e in i)if("function"==typeof i[e]){const t=i[e],s=-1!==e.indexOf("draw");i[e]=(...r)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:e,args:r,isDrawCommand:s}),this._currentSummary&&(this._currentSummary.commands++,s&&this._currentSummary.drawCommands++),t.apply(i,r))}}get enableCommandLogging(){return!("object"==typeof ii&&ii.disableCommands)}recordContainerStart(e){ii&&(this._currentContainer=e)}recordContainerEnd(){ii&&(this._currentContainer=null)}recordPassStart(e){ii&&(this._currentPass=e,this._initSummary())}recordPassEnd(){ii&&(this._currentPass=null,this._emitSummary())}recordBrushStart(e){ii&&(this._currentBrush=e)}recordBrushEnd(){ii&&(this._currentBrush=null)}recordStart(e){if(ii&&(0,m.pC)(this._ext)){if(this._entries.has(e)){const t=this._entries.get(e),i=this._ext.resultAvailable(t.query),s=this._ext.disjoint();if(i&&!s){const i=this._ext.getResult(t.query)/1e6;let s=0;if((0,m.pC)(this._timings.enqueue(i))){const e=this._timings.entries,t=e.length;let i=0;for(const t of e)i+=t;s=i/t}const r=i.toFixed(2),n=s?s.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${e}, ${r} ms (${n} last 10 avg)\n${t.commandsLen} Commands (${t.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(t.summaries),console.log("Commands: ",t.commands),console.groupEnd()):console.log(`Frame report for ${e}, ${r} ms (${n} last 10 avg)`),this._debugOutput.innerHTML=`${r} (${n})`}for(const e of t.handles)e.remove();this._entries.delete(e)}const t={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(t.handles.push(this._events.on("command",(e=>{t.commandsLen++,t.commands.push(e),e.isDrawCommand&&t.drawCommands++}))),t.handles.push(this._events.on("summary",(e=>{t.summaries.push(e)})))),this._ext.beginTimeElapsed(t.query),this._entries.set(e,t)}}recordEnd(e){ii&&(0,m.pC)(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}var ri=i(31563);const ni=n.Z.getLogger("esri.views.2d.engine.webgl.WebGLDriverTest");class ai{constructor(e){this.svgAlwaysPremultipliesAlpha=!1,this._ignoresSamplerPrecision=null,this._context=e,(0,ri.M)(e).then((e=>{this.svgAlwaysPremultipliesAlpha=!e}))}get ignoresSamplerPrecision(){return(0,m.Wi)(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=hi(this._context)),this._ignoresSamplerPrecision}}const oi=e=>new ai(e),hi=e=>{const t=new Q.Z(e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),i=new Uint8Array(4),s=new Pt.Z(e,[0,0,1,0,0,1,1,1]),r=new ne.Z(e,"\nprecision highp float;\n\nattribute vec2 a_pos;\n\nuniform highp sampler2D u_texture;\nvarying vec4 v_color;\n\nfloat getBit(in float bitset, in int bitIndex) {\n  float offset = pow(2.0, float(bitIndex));\n\n  return mod(floor(bitset / offset), 2.0);\n}\n\nvoid main() {\n  vec4 value = texture2D(u_texture, vec2(0.0));\n\n  float bit = getBit(value.x * 255.0, 1);\n\n  v_color = bit * vec4(1.0);\n\n  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n}\n","\nprecision highp float;\n\nvarying vec4 v_color;\n\nvoid main() {\n  gl_FragColor = v_color;\n}\n",{a_pos:0}),n=new Ue.Z(e,{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([2,255,0,0]));r.setUniform1i("u_texture",0),e.bindTexture(n,0);const a=e.getBoundFramebufferObject();e.bindFramebuffer(t),e.bindProgram(r);const{x:o,y:h,width:l,height:d}=e.getViewport();e.setViewport(0,0,1,1),s.draw(),e.setViewport(o,h,l,d),t.readPixels(0,0,1,1,6408,5121,i),r.dispose(),s.dispose(),t.dispose();const u=255!==i[0]||255!==i[1]||255!==i[2]||255!==i[3];return u&&ni.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${i[0]}.${i[1]}.${i[2]}.${i[3]}]`),e.bindFramebuffer(a),u};var li=i(48041);class di{constructor(e,t,i,s,r){this.target=e,this.geometryType=t,this.materialKey=i,this.indexFrom=s,this.indexCount=r}get indexEnd(){return this.indexFrom+this.indexCount}extend(e){this.indexCount+=e}draw(e,t,i){this.target.draw(e,t,i,this.indexFrom,this.indexCount)}}class ui{constructor(e){this._infos=new Array,this._target=e}static from(e,t){const i=new ui(e);for(;t.next();)i.add(t);return i}get _last(){return this._infos[this._infos.length-1]}add(e){const{materialKey:t,indexFrom:i,indexCount:s}=e;if(this._infos.length&&e.materialKey===this._last.materialKey&&e.indexFrom===this._last.indexEnd)this._last.extend(s);else{const e=new di(this._target,this.geometryType,t,i,s);this._infos.push(e)}}forEach(e){for(const t of this._infos)e(t)}}class ci{constructor(e){if(!Array.isArray(e))return void(this.data=e);this.data=e[0];let t=this;for(let i=1;i<e.length;i++)t.next=new ci([e[i]]),t=t.next}find(e){var t;return e(this.data)?this:null==(t=this.next)?void 0:t.find(e)}max(e,t=this){const i=e(this.data)>e(t.data)?this:t;return this.next?this.next.max(e,i):i}remove(e,t=null){return this===e?t?(t.next=this.next,t):this.next:this.next.remove(e,this)}get last(){return this.next?this.next.last:this}}class mi{constructor(e){this._head=null,(0,m.Wi)(e)||(this._head=new ci(e))}get head(){return this._head}maxAvailableSpace(){if((0,m.Wi)(this._head))return 0;const e=this._head.max((e=>e.end-e.start));return e.data.end-e.data.start}firstFit(e){if((0,m.Wi)(this._head))return null;let t=null,i=this._head;for(;i;){const s=i.data.end-i.data.start;if(s===e)return t?t.next=i.next:this._head=i.next,i.data.start;if(s>e){const t=i.data.start;return i.data.start+=e,t}t=i,i=i.next}return null}free(e,t){const i=e+t;if((0,m.Wi)(this._head)){const t=new ci({start:e,end:i});return void(this._head=t)}if(i<=this._head.data.start){if(i===this._head.data.start)return void(this._head.data.start-=t);const s=new ci({start:e,end:i});return s.next=this._head,void(this._head=s)}let s=this._head,r=s.next;for(;r;){if(r.data.start>=i){if(s.data.end===e)return void(s.data.end+=t);if(r.data.start===i)return void(r.data.start-=t);const n=new ci({start:e,end:i});return n.next=s.next,void(s.next=n)}s=r,r=r.next}if(e===s.data.end)return void(s.data.end+=t);const n=new ci({start:e,end:i});s.next=n}}class pi{constructor(e,t,i){const s=new Uint32Array(t*i);this.strideInt=i,this.bufferType=e,this.dirty={start:1/0,end:0},this.cpu=s,this.gpu=null,this.clear()}destroy(){(0,m.Po)(this.gpu,(e=>e.dispose()))}clear(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new mi({start:0,end:this.cpu.length/this.strideInt}),this.fillPointer=0}get bufferSize(){return this.cpu.length/this.strideInt}maxAvailableSpace(){return this.freeList.maxAvailableSpace()}insert(e,t,i,s){const r=i*this.strideInt,n=t*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,a=new Uint32Array(e,n,r),o=(0,m.s3)(this.freeList.firstFit(i),"First fit region must be defined"),h=o*this.strideInt,l=r*this.strideInt,d=o-t;if(0!==s)for(let e=0;e<a.length;e++)a[e]+=s;return this.cpu.set(a,h),this.dirty.start=Math.min(this.dirty.start,h),this.dirty.end=Math.max(this.dirty.end,h+l),this.fillPointer=Math.max(this.fillPointer,h+l),d}free(e,t,i){const s=e*this.strideInt,r=(e+t)*this.strideInt;if(!0===i)for(let i=e;i!==e+t;i++)this.cpu[i*this.strideInt]=2147450879;this.dirty.start=Math.min(this.dirty.start,s),this.dirty.end=Math.max(this.dirty.end,r),this.freeList.free(e,t)}upload(e){if(this.dirty.end){if((0,m.Wi)(this.gpu))return this.gpu=this._createBuffer(e),this.dirty.start=1/0,void(this.dirty.end=0);this.gpu.setSubData(this.cpu,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}}_createBuffer(e){return"index"===this.bufferType?Y.Z.createIndex(e,35048,this.cpu):Y.Z.createVertex(e,35048,this.cpu)}}var _i=i(13356);class fi{constructor(e,t,i,s,r){this._vaoInvalidated=!0;const n=(0,_i.F)(t),a=Math.max(n.indicesPerRecord*n.multiplier*i,r+1),o=Math.max(n.verticesPerRecord*n.multiplier*i,s+1),h=e/Uint32Array.BYTES_PER_ELEMENT,l=new pi("index",a,1),d={geometry:new pi("vertex",o,h)};this.stride=e,this.strideInt=h,this.geometryType=t,this._buffers={index:l,vertex:d}}static createPooled(e,t,i,s,r,n,a){const o=Math.max(p.eq,Math.round(1.5*n)),h=(0,m.Pt)(e,(()=>new fi(t.stride,i,o,s,r)));return h._buffers.index.clear(),h._buffers.vertex.geometry.clear(),h._records=null,h._displayList=null,h._vaoInvalidated=!0,h._pool=a,h._released=!1,h}release(){this.isReleased||(this._pool.release(this),this._released=!0)}destroy(){this._buffers.index.destroy(),this._buffers.vertex.geometry.destroy(),(0,m.Po)(this._vao,(e=>e.dispose(!1)))}get isReleased(){return this._released}get indexBufferSize(){return this._buffers.index.bufferSize}get vertexBufferSize(){return this._buffers.vertex.geometry.bufferSize}get displayList(){return(0,m.Wi)(this._displayList)&&(this._displayList=ui.from(this,this._records.getCursor())),this._displayList}draw(e,t,i,s,r){this.upload(e);const n=this._getVAO(e,t,i),a=Uint32Array.BYTES_PER_ELEMENT*s;e.bindVAO(n),e.drawElements(4,r,5125,a),e.bindVAO(null)}insert(e){if(e.done)return;const{vertexData:t,offset:i}=e,{records:s,indices:r,vertices:n}=t,a=this._getInsertionInfo(li.$.from(s,i)),{vertFrom:o,vertCount:h,indexFrom:l,indexCount:d,recordCount:u,done:c}=a;if(e.done=c,e.offset=u+i,0===u)return;const{index:m,vertex:p}=this._buffers,_=p.geometry.insert(n,o,h,0),f=m.insert(r,l,d,_);this._addRecords(li.$.from(s,i,u),f,_)}free(e){const t=li.$.from(e.records).getCursor();for(;t.next();)this._freeId(t.id)}freeIds(e){for(const t of e)this._freeId(t)}upload(e){const{index:t,vertex:i}=this._buffers;t.upload(e),i.geometry.upload(e)}has(e){if(!this._records)return!1;const t=this._records.getCursor();for(;t.next();)if(t.id===e)return!0;return!1}getViewOf(e){if(!this._records)return null;const t=this._records.getCursor();for(;t.next();)if(t.id===e)return t;return null}_getInsertionInfo(e){const t=e.getCursor(),{index:i,vertex:s}=this._buffers,r=i.maxAvailableSpace(),n=s.geometry.maxAvailableSpace();let a=0,o=null,h=0,l=null,d=0,u=!0;for(;t.next();){null===l&&(l=t.vertexFrom,o=t.indexFrom);const e=d+t.vertexCount,i=h+t.indexCount;if(e>=n||i>=r){u=!1;break}a+=1,h=i,d=e}return{done:u,vertFrom:l,vertCount:d,indexFrom:o,indexCount:h,recordCount:a}}_addRecords(e,t,i){const s=e.getCursor();for(;s.next();)s.indexFrom+=t,s.vertexFrom+=i;this._records?(this._records.link(e),this._displayList=null):this._records=e}_freeId(e){const t=this._records.getCursor(),i=this._buffers.index,s=this._buffers.vertex.geometry;if(!t.lookup(e))return;const r=t.indexFrom;let n=t.indexCount;const a=t.vertexFrom;let o=t.vertexCount;for(;t.next()&&t.id===e;)n+=t.indexCount,o+=t.vertexCount;i.free(r,n),s.free(a,o,!0),this._records.delete(e)}_getVAO(e,t,i){if(this._vaoInvalidated){const e=JSON.stringify(t)+JSON.stringify(i);e!==this._vaoHash&&((0,m.Po)(this._vao,(e=>{e.dispose(!1)})),this._vao=null,this._vaoHash=e),this._vaoInvalidated=!1}if((0,m.Wi)(this._vao)){const{index:s,vertex:r}=this._buffers;if((0,m.Wi)(r.geometry.gpu)||(0,m.Wi)(s.gpu))throw new Error("bad news");this._vao=new X.Z(e,i,t,{geometry:r.geometry.gpu},s.gpu)}return this._vao}}class gi{constructor(){this._pools=new Map}acquire(e,t,i=0){const s=li.$.from(e.records,i),r=s.size();s.next();const n=s.vertexCount,a=s.indexCount,o=this._tryAcquire(e.stride,t,n,a);return fi.createPooled(o,e,t,n,a,r,this)}release(e){e.isReleased||e.destroy()}destroy(){this._pools.forEach((e=>{(0,m.pC)(e)&&e.clear((e=>e.destroy()))}))}_tryAcquire(e,t,i,s){const r=e<<3|t,n=this._pools.get(r);if((0,m.Wi)(n))return null;const a=n.dequeue();return(0,m.pC)(a)&&a.vertexBufferSize>=i&&a.indexBufferSize>=s?a:null}}const vi={shaders:{vertexShader:(0,Me.w)("stencil/stencil.vert"),fragmentShader:(0,Me.w)("stencil/stencil.frag")},attributes:{a_pos:0}};class yi extends ie.W{constructor(e,t){super(),this._trash=new Set,this._clipData=new Float32Array(8),this._upperLeft=(0,N.a)(),this._upperRight=(0,N.a)(),this._lowerLeft=(0,N.a)(),this._lowerRight=(0,N.a)(),this._mat2=(0,j.c)(),this._clipRendererInitialized=!1,this._supersampleScreenshots=!0,this._pools={bufferData:new gi},this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:i=document.createElement("canvas"),alpha:s=!0,stencil:n=!0,renderContext:a="webgl",supersampleScreenshots:o=!0,contextOptions:l={}}=t;this._canvas=i;const d=(0,G.s)(i,{alpha:s,antialias:!1,depth:!0,stencil:n},a);this.context=new ee.Z(d,l),this.painter=new Qt(this.context,this),(0,r.Z)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:t.timeline||new K.T,renderingOptions:t.renderingOptions,requireFBO:!1,driverTestResult:oi(this.context),profiler:new si(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=(0,V.A)({render:e=>this.renderFrame(e)}),this._taskHandle.pause(),this._supersampleScreenshots=o,this._lostWebGLContextHandle=(0,U.on)(i,"webglcontextlost",(()=>{this.emit("webgl-error",{error:new h.Z("webgl-context-lost")})})),i.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(i)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this._pools.bufferData.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=(0,H.S1)(this._highlightOptions,"version",(()=>{this.painter.setHighlightOptions(e),this.requestRender()})))}get pools(){return this._pools}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._lastRenderRequestTime=performance.now(),this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(e){e.time-this._lastRenderRequestTime>=2e3&&this._taskHandle.pause(),this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}renderChildren(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)}_renderChildren(e,t){const i=this.context;t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this._beforeRenderChildren(t),t.drawPhase=te.jx.MAP,this.painter.beforeRenderLayers(i,this.background);for(const i of e)i.processRender(t);this.painter.renderLayers(i),t.drawPhase=te.jx.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const i of e)i.processRender(t);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=te.jx.LABEL,this.painter.beforeRenderLayers(i);for(const i of e)i.processRender(t);this.painter.renderLayers(i)}if((0,r.Z)("esri-tiles-debug")){t.drawPhase=te.jx.DEBUG,this.painter.beforeRenderLayers(i);for(const i of e)i.processRender(t);this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),this._afterRenderChildren()}_beforeRenderChildren(e){const{context:t}=this,{state:i,pixelRatio:s}=e;t.enforceState();const{size:r,rotation:n}=i,a=Math.round(r[0]*s),o=Math.round(r[1]*s);if(this._boundFBO=t.getBoundFramebufferObject(),!i.spatialReference||!(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable))return void(this._clipFrame=!1);const h=(0,Z.t)(n),l=Math.abs(Math.cos(h)),d=Math.abs(Math.sin(h)),u=Math.round(a*l+o*d),c=Math.round(i.worldScreenWidth);if(u<=c)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===a&&this._clipFBO.height===o||(this._clipFBO=new Q.Z(t,{colorTarget:0,depthStencilTarget:3,width:a,height:o}));const m=(this.state.padding.left-this.state.padding.right)/2,p=(this.state.padding.bottom-this.state.padding.top)/2,_=.5*a,f=.5*o,g=1/a,v=1/o,y=c*s*.5,w=.5*(a*d+o*l),b=this._upperLeft,x=this._upperRight,C=this._lowerLeft,M=this._lowerRight;(0,q.s)(b,-y,-w),(0,q.s)(x,y,-w),(0,q.s)(C,-y,w),(0,q.s)(M,y,w),(0,$.i)(this._mat2),(0,$.t)(this._mat2,this._mat2,[_+m,f+p]),0!==n&&(0,$.r)(this._mat2,this._mat2,h),(0,q.t)(b,b,this._mat2),(0,q.t)(x,x,this._mat2),(0,q.t)(C,C,this._mat2),(0,q.t)(M,M,this._mat2);const T=this._clipData;T.set([2*C[0]*g-1,2*(o-C[1])*v-1,2*M[0]*g-1,2*(o-M[1])*v-1,2*b[0]*g-1,2*(o-b[1])*v-1,2*x[0]*g-1,2*(o-x[1])*v-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(T),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0}_afterRenderChildren(){const e=this.context;if(e.logIno(),this._clipFrame&&this._clipRendererInitialized){if(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.bindProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),null!=this.background){const{r:t,g:i,b:s,a:r}=this.background.color;e.setClearColor(r*t/255,r*i/255,r*s/255,r)}else e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this.painter.blitTexture(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1)}}doRender(e){const t=this.context,{state:i,pixelRatio:s}=e;this._resizeCanvas(e),this.context.enforceState(),t.setViewport(0,0,s*i.size[0],s*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),super.doRender(e)}async takeScreenshot(e,t){const i=(0,W.$3)(e,this._supersampleScreenshots,this._state.padding),{framebufferWidth:s,framebufferHeight:r}=i,n=this.context,a=e.layers;let o=this.children;const h={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:this._renderParameters.state.clone(),pixelRatio:i.pixelRatio,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1};if(null!=e.rotation){const t=h.state.viewpoint;t.rotation=e.rotation,h.state.viewpoint=t}a.length>0&&(o=[],a.forEach((e=>{const i=t.find((t=>t.layer.id===e.id));i&&"container"in i&&i.container&&o.push(i.container)})));const l=new Q.Z(n,{colorTarget:0,depthStencilTarget:3,width:s,height:r}),d=n.getBoundFramebufferObject(),u=n.getViewport();n.bindFramebuffer(l),n.setViewport(0,0,s,r),this._renderChildren(o,h);const c=this._readbackScreenshot(i);n.bindFramebuffer(d),n.setViewport(u.x,u.y,u.width,u.height),this.requestRender();const m=this._ensureScreenshotEncodeCanvas();return(0,W.gH)(c,e,m,{flipY:!0,premultipliedAlpha:!0})}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}_readbackScreenshot(e){const{framebufferWidth:t,framebufferHeight:i,region:s,resample:r}=e,n=this.context.gl;if(r){const e=(0,W.r7)(t,i,this._ensureScreenshotEncodeCanvas());n.readPixels(0,0,t,i,6408,5121,new Uint8Array(e.data.buffer));const a=(0,W.r7)(s.width,s.height,this._ensureScreenshotEncodeCanvas());return(0,W.TT)(e,a,!0,r.region.x,i-(r.region.y+r.region.height),r.region.width,r.region.height)}{const e=(0,W.r7)(s.width,s.height,this._ensureScreenshotEncodeCanvas());return n.readPixels(s.x,i-(s.y+s.height),s.width,s.height,6408,5121,new Uint8Array(e.data.buffer)),e}}_resizeCanvas(e){const t=this._canvas,i=t.style,{state:{size:s},pixelRatio:r}=e,n=s[0],a=s[1],o=Math.round(n*r),h=Math.round(a*r);t.width===o&&t.height===h||(t.width=o,t.height=h),i.width=n+"px",i.height=a+"px"}_initializeClipRenderer(e){if(this._clipRendererInitialized)return!0;const t=vi.attributes,i=(0,J.H)(e,vi);if(!i)return!1;const s=Y.Z.createVertex(e,35040,32),r=new Uint16Array([0,1,2,2,1,3]),n=Y.Z.createIndex(e,35044,r),a=new X.Z(e,t,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:s},n);return this._clipStencilProgram=i,this._clipVBO=s,this._clipVAO=a,this._clipRendererInitialized=!0,!0}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}}_isLabelDrawPhaseRequired(e){let t=!1;for(const i of e){if(!(i instanceof ie.W)){t=t||!1;break}if(i.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(i.children)}return t}}var wi=i(28301),bi=i(24989),xi=i(61106),Ci=i(65984),Mi=i(15187);const Ti="Shift";let Si=class extends d.Z{constructor(e){super(e),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(e){this._handles&&this._handles.forEach((e=>{e.remove()})),this._handles=null,this._destroyOverlay(),this._set("view",e),e&&(e.on("drag",[Ti],(e=>this._handleDrag(e,1))),e.on("drag",[Ti,"Ctrl"],(e=>this._handleDrag(e,-1))))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(e,t,i,s){this._box.x=e,this._box.y=t,this._box.width=i,this._box.height=s,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(e,t,i,s,r){const n=this.view,a=n.toMap((0,g.vW)(e+.5*i,t+.5*s));let o=Math.max(i/n.width,s/n.height);-1===r&&(o=1/o),this._destroyOverlay(),this.navigation.end(),n.goTo({center:a,scale:n.scale*o})}_updateBox(e,t,i,s){const r=this._boxShape;r.setAttributeNS(null,"x",""+e),r.setAttributeNS(null,"y",""+t),r.setAttributeNS(null,"width",""+i),r.setAttributeNS(null,"height",""+s),r.setAttributeNS(null,"class","esri-zoom-box__outline")}_updateBackground(e,t,i,s){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(e,t,i,s,this.view.width,this.view.height))}_createContainer(){const e=document.createElement("div");e.className="esri-zoom-box__container",this.view.root.appendChild(e),this._container=e}_createOverlay(){const e=this.view.width,t=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+e+" 0 L "+e+" "+t+" L 0 "+t+" Z"),i.setAttributeNS(null,"class","esri-zoom-box__overlay-background");const s=document.createElementNS("http://www.w3.org/2000/svg","rect"),r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),r.setAttributeNS(null,"class","esri-zoom-box__overlay"),r.appendChild(i),r.appendChild(s),this._container.appendChild(r),this._backgroundShape=i,this._boxShape=s,this._overlay=r}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(e,t,i,s,r,n){const a=e+i,o=t+s;return"M 0 0 L "+r+" 0 L "+r+" "+n+" L 0 "+n+" ZM "+e+" "+t+" L "+e+" "+o+" L "+a+" "+o+" L "+a+" "+t+" Z"}_handleDrag(e,t){const i=e.x,s=e.y,r=e.origin.x,n=e.origin.y;let a,o,h,l;switch(i>r?(a=r,h=i-r):(a=i,h=r-i),s>n?(o=n,l=s-n):(o=s,l=n-s),e.action){case"start":this._start();break;case"update":this._update(a,o,h,l);break;case"end":this._end(a,o,h,l,t)}e.stopPropagation()}_redraw(){if(!this._rafId)return;if(this._rafId=null,!this._overlay)return;const{x:e,y:t,width:i,height:s}=this._box;this._updateBox(e,t,i,s),this._updateBackground(e,t,i,s),this._rafId=requestAnimationFrame(this._redraw)}};(0,s._)([(0,a.Cb)()],Si.prototype,"navigation",void 0),(0,s._)([(0,a.Cb)()],Si.prototype,"view",null),Si=(0,s._)([(0,o.j)("esri.views.2d.navigation.ZoomBox")],Si);const Fi=Si;i(36348);var Pi=i(77625),Ri=i(17387);class zi{constructor(e){this.gain=e}update(e){if(this.hasLastValue){const t=this.computeDelta(e);this.updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return void 0!==this.lastValue}get hasFilteredDelta(){return void 0!==this.filteredDelta}computeDelta(e){return e-this.lastValue}updateDelta(e){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*e:this.filteredDelta=e}}class Ii{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}class Di extends Ii{constructor(e,t,i,s,r){super(e,t,i),this.sceneVelocity=s,this.direction=r}value(e){return super.valueFromInitialVelocity(this.sceneVelocity,e)}}class Bi{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.time=new zi(.6),this.screen=[new zi(.4),new zi(.4)],this.scene=[new zi(.6),new zi(.6),new zi(.6)],this.tmpDirection=(0,Pi.c)()}add(e,t,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(t[0]),this.scene[1].update(t[1]),this.scene[2].update(t[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){(0,Ri.s)(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const s=(0,Ri.l)(this.tmpDirection);s>0&&(0,Ri.a)(this.tmpDirection,this.tmpDirection,1/s);const r=s/this.time.filteredDelta;return new Di(e,t,i,r,this.tmpDirection)}}let Oi=class extends d.Z{constructor(e){super(e),this.animationTime=0,this.momentumEstimator=new Bi(500,6,.92),this.momentum=null,this.tmpMomentum=(0,Pi.c)(),this.momentumFinished=!1,this.viewpoint=new Ci.Z({targetGeometry:new xi.Z,scale:0,rotation:0}),this.watch("momentumFinished",(e=>{e&&this.navigation.stop()}))}begin(e,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this.previousDrag=t}update(e,t){this.addToEstimator(t);let i=t.center.x,s=t.center.y;const r=this.previousDrag;i=r?r.center.x-i:-i,s=r?s-r.center.y:s,e.viewpoint=(0,Mi.Rx)(this.viewpoint,e.viewpoint,[i||0,s||0]),this.previousDrag=t}end(e,t){this.addToEstimator(t);const i=e.navigation.momentumEnabled;this.momentum=i?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(e),this.previousDrag=null,this.navigation.end()}addToEstimator(e){const t=e.center.x,i=e.center.y,s=(0,g.s1)(-t,i),r=(0,Pi.f)(-t,i,0);this.momentumEstimator.add(s,r,.001*e.timestamp)}onAnimationUpdate(e){this.navigation.animationManager.animateContinous(e.viewpoint,((t,i)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const s=.001*i;if(!this.momentumFinished){const i=this.momentum.valueDelta(this.animationTime,s);(0,Ri.a)(this.tmpMomentum,this.momentum.direction,i),(0,Mi.Rx)(t,t,this.tmpMomentum),e.constraints.constrainByGeometry(t)}this.animationTime+=s}))}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};(0,s._)([(0,a.Cb)()],Oi.prototype,"momentumFinished",void 0),(0,s._)([(0,a.Cb)()],Oi.prototype,"viewpoint",void 0),(0,s._)([(0,a.Cb)()],Oi.prototype,"navigation",void 0),Oi=(0,s._)([(0,o.j)("esri.views.2d.navigation.actions.Pan")],Oi);const Ei=Oi;class Ai{constructor(e=2.5,t=.01,i=.95,s=12){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.maxVelocity=s,this.enabled=!0,this.value=new zi(.8),this.time=new zi(.3)}add(e,t){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta){const t=this.value.computeDelta(e);this.value.filteredDelta*t<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=(0,f.uZ)(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}createMomentum(e,t,i){return new Ii(e,t,i)}}class ki extends Ai{constructor(e=3,t=.01,i=.95,s=12){super(e,t,i,s)}add(e,t){if(this.value.hasLastValue){const t=this.value.lastValue;let i=e-t;for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;e=t+i}super.add(e,t)}}class Li extends Ii{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),s=super.value(e+t)-i;return Math.exp(s)}}class Ui extends Ai{constructor(e=2.5,t=.01,i=.95,s=12){super(e,t,i,s)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new Li(e,t,i)}}let Vi=class extends d.Z{constructor(e){super(e),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new ki(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new Ui,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new Ci.Z({targetGeometry:new xi.Z,scale:0,rotation:0}),this.watch("_momentumFinished",(e=>{e&&this.navigation.stop()}))}begin(e,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,e.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}update(e,t){null===this._updateTimestamp&&(this._updateTimestamp=t.timestamp);const i=t.angle,s=t.radius,r=t.center,n=Math.abs(180*(i-this._startAngle)/Math.PI),a=Math.abs(s-this._startRadius),o=this._startRadius/s;if(this._previousRadius){const h=s/this._previousRadius;let l=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=l>=0?1:-1,this._zoomDirection=h>=1?1:-1,e.constraints.rotationEnabled?(null===this._zoomOnly&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=a-n>0),null===this._zoomOnly||this._zoomOnly?l=0:this.addToRotateEstimator(i-this._startAngle,t.timestamp)):l=0,this.addToZoomEstimator(t,o),this.navigation.setViewpoint([r.x,r.y],1/h,l,[this._previousCenter.x-r.x,r.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=s,this._previousCenter=r}end(e){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(e),this.navigation.end()}addToRotateEstimator(e,t){this._rotationMomentumEstimator.add(e,.001*t)}addToZoomEstimator(e,t){this._zoomMomentumEstimator.add(t,.001*e.timestamp)}canZoomIn(e){const t=e.scale,i=e.constraints.effectiveMaxScale;return 0===i||t>i}canZoomOut(e){const t=e.scale,i=e.constraints.effectiveMinScale;return 0===i||t<i}onAnimationUpdate(e){this.navigation.animationManager.animateContinous(e.viewpoint,((t,i)=>{const s=!this.canZoomIn(e)&&this._zoomDirection>1||!this.canZoomOut(e)&&this._zoomDirection<1,r=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),n=s||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),a=.001*i;if(this._momentumFinished=r&&n,!this._momentumFinished){const i=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,a))*this._rotationDirection*180/Math.PI:0;let s=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,a)):1;const r=(0,N.a)(),n=(0,N.a)();if(this._previousCenter){(0,q.s)(r,this._previousCenter.x,this._previousCenter.y),(0,Mi.Dq)(n,e.size,e.padding),(0,q.h)(r,r,n);const{constraints:a,scale:o}=e,h=o*s;s<1&&!a.canZoomInTo(h)?(s=o/a.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):s>1&&!a.canZoomOutTo(h)&&(s=o/a.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),(0,Mi.UZ)(t,e.viewpoint,s,i,r,e.size),e.constraints.constrainByGeometry(t)}}this._animationTime+=a}))}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};(0,s._)([(0,a.Cb)()],Vi.prototype,"_momentumFinished",void 0),(0,s._)([(0,a.Cb)()],Vi.prototype,"viewpoint",void 0),(0,s._)([(0,a.Cb)()],Vi.prototype,"navigation",void 0),Vi=(0,s._)([(0,o.j)("esri.views.2d.navigation.actions.Pinch")],Vi);const Zi=Vi,Hi=(0,N.a)(),Ni=(0,N.a)();let Wi=class extends d.Z{constructor(e){super(e),this._previousCenter=(0,N.a)(),this.viewpoint=new Ci.Z({targetGeometry:new xi.Z,scale:0,rotation:0})}begin(e,t){this.navigation.begin(),(0,q.s)(this._previousCenter,t.center.x,t.center.y)}update(e,t){const{state:{size:i,padding:s}}=e;(0,q.s)(Hi,t.center.x,t.center.y),(0,Mi.ni)(Ni,i,s),e.viewpoint=(0,Mi.$H)(this.viewpoint,e.state.paddedViewState.viewpoint,(0,Mi.dI)(Ni,this._previousCenter,Hi)),(0,q.c)(this._previousCenter,Hi)}end(){this.navigation.end()}};(0,s._)([(0,a.Cb)()],Wi.prototype,"viewpoint",void 0),(0,s._)([(0,a.Cb)()],Wi.prototype,"navigation",void 0),Wi=(0,s._)([(0,o.j)("esri.views.2d.actions.Rotate")],Wi);const qi=Wi,Gi=new Ci.Z({targetGeometry:new xi.Z}),$i=[0,0];let ji=class extends d.Z{constructor(e){super(e),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new Ei({navigation:this}),this.rotate=new qi({navigation:this}),this.pinch=new Zi({navigation:this}),this.zoomBox=new Fi({view:this.view,navigation:this})}destroy(){this.zoomBox.destroy(),this.zoomBox=null,this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}async zoom(e,t=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return e<1?this.zoomIn(t):this.zoomOut(t);this.setViewpoint(t,e,0,[0,0])}async zoomIn(e){const t=this.view,i=t.constraints.snapToNextScale(t.scale);return this._zoomToScale(i,e)}async zoomOut(e){const t=this.view,i=t.constraints.snapToPreviousScale(t.scale);return this._zoomToScale(i,e)}setViewpoint(e,t,i,s){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,e,t,i,s),this.end()}setViewpointImmediate(e,t=0,i=[0,0],s=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,s,e,t,i)}continousRotateClockwise(){const e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(e=>{(0,Mi.$H)(e,e,-1)}))}continousRotateCounterclockwise(){const e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(e=>{(0,Mi.$H)(e,e,1)}))}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-10,0])}continousPanRight(){this._continuousPan([10,0])}continousPanUp(){this._continuousPan([0,10])}continousPanDown(){this._continuousPan([0,-10])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(e){const t=this.get("view.viewpoint");this.animationManager.animateContinous(t,(t=>{(0,Mi.Rx)(t,t,e),this.view.constraints.constrainByGeometry(t)}))}_startTimer(e){return null!==this._endTimer||(this._endTimer=setTimeout((()=>{this._endTimer=null;const e=performance.now()-this._lastEventTimestamp;e<250?this._endTimer=this._startTimer(e):this._set("interacting",!1)}),e)),this._endTimer}_getDefaultAnchor(){const{size:e,padding:{left:t,right:i,top:s,bottom:r}}=this.view;return $i[0]=.5*(e[0]-i+t),$i[1]=.5*(e[1]-r+s),$i}async _zoomToScale(e,t=this._getDefaultAnchor()){const{view:i}=this,{constraints:s,scale:r,viewpoint:n,size:a,padding:o}=i,h=s.canZoomInTo(e),l=s.canZoomOutTo(e);if(!(e<r&&!h||e>r&&!l))return(0,Mi.gG)(Gi,n,e/r,0,t,a,o),s.constrainByGeometry(Gi),i.goTo(Gi,{animate:!0})}_scaleRotateTranslateViewpoint(e,t,i,s,r){const{view:n}=this,{size:a,padding:o,constraints:h,scale:l,viewpoint:d}=n,u=l*i,c=h.canZoomInTo(u),m=h.canZoomOutTo(u);return(i<1&&!c||i>1&&!m)&&(i=1),(0,Mi.Rx)(d,d,r),(0,Mi.gG)(e,d,i,s,t,a,o),h.constrainByGeometry(e)}};(0,s._)([(0,a.Cb)()],ji.prototype,"animationManager",void 0),(0,s._)([(0,a.Cb)({type:Boolean,readOnly:!0})],ji.prototype,"interacting",void 0),(0,s._)([(0,a.Cb)()],ji.prototype,"pan",void 0),(0,s._)([(0,a.Cb)()],ji.prototype,"pinch",void 0),(0,s._)([(0,a.Cb)()],ji.prototype,"rotate",void 0),(0,s._)([(0,a.Cb)()],ji.prototype,"view",void 0),(0,s._)([(0,a.Cb)()],ji.prototype,"zoomBox",void 0),ji=(0,s._)([(0,o.j)("esri.views.2d.navigation.MapViewNavigation")],ji);const Ki=ji;var Yi=i(59691),Xi=i(56291),Qi=i(41419);const Ji={shaders:{vertexShader:(0,Me.w)("magnifier/magnifier.vert"),fragmentShader:(0,Me.w)("magnifier/magnifier.frag")},attributes:{a_pos:0}};class es extends Xi.s{constructor(){super(),this._handles=new Yi.Z,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,H.S1)(e,"version",(()=>{this.visible=e.visible&&(0,m.pC)(e.position)&&e.size>0,this.requestRender()})),e.watch(["mask","overlay"],(()=>this._reloadResources())),e.watch("size",(()=>{this._disposeRenderResources(),this.requestRender()}))])}doRender(e){var t;const i=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==te.jx.MAP||!this._canRender())return;this._updateResources(e);const s=this._magnifier;if((0,m.Wi)(s.position))return;const r=e.pixelRatio,n=s.size*r,a=1/s.factor,o=Math.ceil(a*n);this._readbackTexture.resize(o,o);const{size:h}=e.state,l=r*h[0],d=r*h[1],u=.5*o,c=.5*o,p=(0,f.uZ)(r*s.position.x,u,l-u-1),_=(0,f.uZ)(d-r*s.position.y,c,d-c-1);i.setBlendingEnabled(!0);const g=p-u,v=_-c,y=this._readbackTexture;i.bindTexture(y,0),i.gl.copyTexImage2D(y.descriptor.target,0,y.descriptor.pixelFormat,g,v,o,o,0);const w=null==(t=this.background)?void 0:t.color,b=w?[w.a*w.r/255,w.a*w.g/255,w.a*w.b/255,w.a]:[1,1,1,1],x=(p+s.offset.x*r)/l*2-1,C=(_-s.offset.y*r)/d*2-1,M=n/l*2,T=n/d*2,S=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.bindProgram(S),S.setUniform4fv("u_background",b),S.setUniform1i("u_readbackTexture",0),S.setUniform1i("u_overlayTexture",6),S.setUniform1i("u_maskTexture",7),S.setUniform4f("u_drawPos",x,C,M,T),S.setUniform1i("u_maskEnabled",s.maskEnabled?1:0),S.setUniform1i("u_overlayEnabled",s.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(5,0,4),i.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){this._resourcesTask&&this._resourcesTask.abort();const e=(0,m.pC)(this._magnifier)?this._magnifier.maskUrl:null,t=(0,m.pC)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=(0,Be.vr)((async s=>{const r=(0,m.Wi)(e)||(0,m.Wi)(t)?async function(e){const t=i.e(806).then(i.bind(i,70806)),s=i.e(6004).then(i.bind(i,76004)),r=(0,Qi.t)((await t).default,{signal:e}),n=(0,Qi.t)((await s).default,{signal:e}),a={mask:await r,overlay:await n};return(0,Be.k_)(e),a}(s):null,n=(0,m.pC)(e)?(0,Oe.default)(e,{responseType:"image",signal:s}).then((e=>e.data)):r.then((e=>e.mask)),a=(0,m.pC)(t)?(0,Oe.default)(t,{responseType:"image",signal:s}).then((e=>e.data)):r.then((e=>e.overlay)),[o,h]=await Promise.all([n,a]);this.mask=o,this.overlay=h,this._disposeRenderResources(),this.requestRender()}))}_disposeRenderResources(){this._readbackTexture=(0,m.O3)(this._readbackTexture),this._overlayTexture=(0,m.O3)(this._overlayTexture),this._maskTexture=(0,m.O3)(this._maskTexture),this._vertexArrayObject=(0,m.O3)(this._vertexArrayObject),this._program=(0,m.O3)(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const t=e.context;this._resourcePixelRatio=e.pixelRatio;const i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=function(e){return(0,J.H)(e,Ji)}(t);const s=new Uint16Array([0,1,0,0,1,1,1,0]),r=Ji.attributes;this._vertexArrayObject=new X.Z(t,r,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:Y.Z.createVertex(t,35044,s)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new Ue.Z(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,preMultiplyAlpha:!(0,l.zd)(this.overlay.src)||!e.driverTestResult.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new Ue.Z(t,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);const n=1/this._magnifier.factor;this._readbackTexture=new Ue.Z(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.ceil(n*i),height:Math.ceil(n*i)})}}const ts=es},31563:(e,t,i)=>{"use strict";i.d(t,{M:()=>h}),i(95830);var s=i(51007),r=i(69595),n=i(8634),a=i(74038),o=i(84570);async function h(e){const t=new Image;if(t.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",t.width=5,t.height=5,await t.decode(),!e.gl)return!0;const i=new o.Z(e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),h=r.Z.createVertex(e,35044,new Uint16Array([0,0,1,0,0,1,1,1])),l=new a.Z(e,{a_pos:0},{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1}]},{geometry:h}),d=new s.Z(e,"\n  precision highp float;\n\n  attribute vec2 a_pos;\n  varying vec2 v_uv;\n\n  void main() {\n    v_uv = a_pos;\n    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n  }\n  ","\n  precision highp float;\n\n  varying vec2 v_uv;\n  uniform sampler2D u_texture;\n\n  void main() {\n    gl_FragColor = texture2D(u_texture, v_uv);\n  }\n  ",{a_pos:0});e.bindProgram(d);const u=new n.Z(e,{dataType:5121,pixelFormat:6408,preMultiplyAlpha:!1,wrapMode:33071,samplingMode:9729},t);e.bindTexture(u,0),d.setUniform1i("u_texture",0);const c=e.getBoundFramebufferObject(),{x:m,y:p,width:_,height:f}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.bindVAO(l),e.drawArrays(5,0,4);const g=new Uint8Array(4);return i.readPixels(0,0,1,1,6408,5121,g),d.dispose(),l.dispose(!1),h.dispose(),i.dispose(),u.dispose(),e.setViewport(m,p,_,f),e.bindFramebuffer(c),t.src="",255===g[0]}}}]);